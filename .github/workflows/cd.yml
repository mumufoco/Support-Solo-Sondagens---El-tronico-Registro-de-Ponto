name: CD Pipeline

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Build and Push Docker Images
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push PHP image
        uses: docker/build-push-action@v5
        with:
          context: .
          target: php
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/php:${{ github.sha }},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/php:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/php:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/php:buildcache,mode=max

      - name: Build and push Nginx image
        uses: docker/build-push-action@v5
        with:
          context: .
          target: nginx
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/nginx:${{ github.sha }},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/nginx:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/nginx:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/nginx:buildcache,mode=max

      - name: Build and push DeepFace image
        uses: docker/build-push-action@v5
        with:
          context: .
          target: deepface
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/deepface:${{ github.sha }},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/deepface:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/deepface:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/deepface:buildcache,mode=max

  # Deploy to Staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.pontoeletronico.com.br

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.STAGING_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to staging server
        run: |
          ssh ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'EOF'
            cd ${{ secrets.STAGING_PATH }}

            # Enable maintenance mode
            touch writable/maintenance.lock

            # Pull latest code
            git fetch origin
            git checkout develop
            git pull origin develop

            # Pull latest Docker images
            docker-compose pull

            # Run migrations
            docker-compose exec -T php php spark migrate --all

            # Restart services
            docker-compose up -d --no-deps --build

            # Clear cache
            docker-compose exec -T php php spark cache:clear
            docker-compose exec -T redis redis-cli FLUSHDB

            # Disable maintenance mode
            rm -f writable/maintenance.lock

            echo "âœ… Staging deployment completed!"
          EOF

      - name: Health check
        run: |
          sleep 10
          curl -f https://staging.pontoeletronico.com.br/health || exit 1

      - name: Notify deployment success
        if: success()
        run: echo "âœ… Staging deployment successful!"

      - name: Notify deployment failure
        if: failure()
        run: echo "âŒ Staging deployment failed!"

  # Deploy to Production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://pontoeletronico.com.br

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.PRODUCTION_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts

      - name: Create backup
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
            cd ${{ secrets.PRODUCTION_PATH }}
            ./scripts/backup.sh
          EOF

      - name: Deploy to production server
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
            cd ${{ secrets.PRODUCTION_PATH }}

            # Enable maintenance mode
            touch writable/maintenance.lock

            # Pull latest code
            git fetch origin
            git checkout main
            git pull origin main

            # Pull latest Docker images
            docker-compose pull

            # Run migrations
            docker-compose exec -T php php spark migrate --all

            # Restart services (zero-downtime)
            docker-compose up -d --no-deps --build

            # Clear cache
            docker-compose exec -T php php spark cache:clear
            docker-compose exec -T redis redis-cli FLUSHDB

            # Wait for services to be healthy
            sleep 15

            # Disable maintenance mode
            rm -f writable/maintenance.lock

            echo "âœ… Production deployment completed!"
          EOF

      - name: Health check
        run: |
          sleep 10
          curl -f https://pontoeletronico.com.br/health || exit 1

      - name: Verify database
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
            cd ${{ secrets.PRODUCTION_PATH }}
            docker-compose exec -T mysql mysqladmin ping -h localhost -u root -p$MYSQL_ROOT_PASSWORD
          EOF

      - name: Notify deployment success
        if: success()
        run: echo "âœ… Production deployment successful!"

      - name: Rollback on failure
        if: failure()
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
            cd ${{ secrets.PRODUCTION_PATH }}
            echo "âŒ Deployment failed! Rolling back..."

            # Restore from latest backup
            LATEST_BACKUP=$(ls -t backups/*.tar.gz | head -1)
            if [ -f "$LATEST_BACKUP" ]; then
              echo "Restoring from: $LATEST_BACKUP"
              tar -xzf "$LATEST_BACKUP" -C /tmp/restore

              # Restore database
              gunzip < /tmp/restore/database.sql.gz | docker-compose exec -T mysql mysql -u root -p$MYSQL_ROOT_PASSWORD ponto_eletronico

              # Restore files
              cp -r /tmp/restore/writable/* writable/
              cp -r /tmp/restore/public/uploads/* public/uploads/

              # Restart services
              docker-compose restart

              rm -rf /tmp/restore
              echo "âœ… Rollback completed!"
            else
              echo "âŒ No backup found for rollback!"
            fi

            rm -f writable/maintenance.lock
          EOF

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: deploy-production
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: |
            ## ðŸš€ Release ${{ github.ref_name }}

            ### Changes
            ${{ steps.changelog.outputs.changelog }}

            ### Docker Images
            - PHP: `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/php:${{ github.ref_name }}`
            - Nginx: `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/nginx:${{ github.ref_name }}`
            - DeepFace: `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/deepface:${{ github.ref_name }}`

            ### Deployment
            - Production: https://pontoeletronico.com.br
            - Staging: https://staging.pontoeletronico.com.br
          draft: false
          prerelease: false
