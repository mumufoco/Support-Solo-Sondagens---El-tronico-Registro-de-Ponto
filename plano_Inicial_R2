# PLANO COMPLETO PARA CLAUDE CODE - VERS√ÉO 2.0 ATUALIZADA
## Sistema de Ponto Eletr√¥nico Brasileiro - Desenvolvimento Agentico

**ATUALIZA√á√ÉO IMPORTANTE:** Sistema otimizado com DeepFace (sem Docker) ao inv√©s de CompreFace

---

## üìã √çNDICE

1. [Vis√£o Geral do Projeto](#1-vis√£o-geral-do-projeto)
2. [Fluxogramas Completos](#2-fluxogramas-completos)
3. [Estrutura do Projeto](#3-estrutura-do-projeto)
4. [Comandos Claude Code por Fase](#4-comandos-claude-code-por-fase)
5. [Prompts Detalhados](#5-prompts-detalhados)
6. [Testes e Valida√ß√£o](#6-testes-e-valida√ß√£o)

---

## 1. VIS√ÉO GERAL DO PROJETO

### 1.1 Objetivo
Desenvolver aplicativo web de ponto eletr√¥nico para empresas brasileiras (20-30 funcion√°rios) em conformidade com:
- Portaria MTE 671/2021
- CLT Art. 74
- LGPD Lei 13.709/2018

### 1.2 Stack Tecnol√≥gica ATUALIZADA

```
Backend:      CodeIgniter 4 (PHP 8.1+)
Frontend:     HTML5, JavaScript, Bootstrap 5
Banco:        MySQL 8.0+
Biometria:    DeepFace (Python + Flask) - SEM DOCKER
              SourceAFIS (Java - opcional)
Mapas:        OpenStreetMap + Leaflet.js
Servidor:     VPS Ubuntu 22.04 (4GB RAM)
```

### 1.3 M√≥dulos Principais

1. **Autentica√ß√£o** (Login/Registro/Perfis)
2. **Registro de Ponto** (C√≥digo/QR/Facial/Biometria)
3. **Geolocaliza√ß√£o** (Cerca virtual)
4. **Justificativas** (Faltas/Atrasos + Anexos)
5. **Folha de Ponto** (C√°lculo autom√°tico)
6. **Relat√≥rios** (Exporta√ß√£o/Visualiza√ß√£o)
7. **Chat Interno** (WebSocket)
8. **Configura√ß√µes** (Admin/APIs)
9. **Advert√™ncias** (Assinatura digital)
10. **LGPD** (Consentimentos/Audit)

### 1.4 Mudan√ßas da Vers√£o 2.0

**REMOVIDO:**
- ‚ùå CompreFace (Docker obrigat√≥rio)
- ‚ùå Docker Compose para facial
- ‚ùå 4GB RAM obrigat√≥rios
- ‚ùå Complexidade de containers

**ADICIONADO:**
- ‚úÖ DeepFace (Python simples)
- ‚úÖ Instala√ß√£o via pip
- ‚úÖ Apenas 400MB RAM para facial
- ‚úÖ Anti-spoofing integrado
- ‚úÖ 8 modelos dispon√≠veis
- ‚úÖ An√°lise de atributos (idade, g√™nero, emo√ß√£o)

---

## 2. FLUXOGRAMAS COMPLETOS

### 2.1 Fluxograma Geral do Sistema

```mermaid
graph TB
    Start([Usu√°rio acessa sistema]) --> Login{Login v√°lido?}
    Login -->|N√£o| LoginPage[P√°gina de Login]
    LoginPage --> RegisterOpt{Novo usu√°rio?}
    RegisterOpt -->|Sim| Register[Registro de Conta]
    RegisterOpt -->|N√£o| LoginPage
    Register --> Login
    
    Login -->|Sim| CheckRole{Verificar Perfil}
    
    CheckRole -->|Admin| AdminDash[Dashboard Admin]
    CheckRole -->|Gestor| GestorDash[Dashboard Gestor]
    CheckRole -->|Funcion√°rio| FuncDash[Dashboard Funcion√°rio]
    
    AdminDash --> AdminActions[Configura√ß√µes<br/>Relat√≥rios Globais<br/>Gerenciar Usu√°rios<br/>APIs/Integra√ß√µes]
    GestorDash --> GestorActions[Bater Ponto<br/>Cadastrar Funcion√°rios<br/>Justificar Aus√™ncias<br/>Relat√≥rios de Equipe]
    FuncDash --> FuncActions[Bater Ponto<br/>Consultar Jornada<br/>Justificar Faltas]
    
    AdminActions --> End([Logout])
    GestorActions --> End
    FuncActions --> End
```

### 2.2 Fluxograma - Registro de Ponto com DeepFace

```mermaid
graph TB
    Start([Funcion√°rio clica<br/>"Bater Ponto"]) --> CheckSchedule{Dentro do<br/>hor√°rio permitido?}
    
    CheckSchedule -->|N√£o| BlockMsg[Mensagem: Fora do<br/>expediente]
    BlockMsg --> End([Retornar ao Dashboard])
    
    CheckSchedule -->|Sim| SelectMethod{Escolher m√©todo<br/>de registro}
    
    SelectMethod -->|C√≥digo √önico| EnterCode[Digitar c√≥digo]
    SelectMethod -->|QR Code| ScanQR[Escanear QR Code]
    SelectMethod -->|Facial| CapturePhoto[Capturar foto facial]
    SelectMethod -->|Biometria| ScanFingerprint[Escanear impress√£o digital]
    
    EnterCode --> ValidateCode{C√≥digo v√°lido?}
    ValidateCode -->|N√£o| ErrorCode[Erro: C√≥digo inv√°lido]
    ErrorCode --> SelectMethod
    ValidateCode -->|Sim| GetLocation
    
    ScanQR --> ValidateQR{QR v√°lido?}
    ValidateQR -->|N√£o| ErrorQR[Erro: QR inv√°lido]
    ErrorQR --> SelectMethod
    ValidateQR -->|Sim| GetLocation
    
    CapturePhoto --> CheckQuality{Foto com<br/>qualidade adequada?}
    CheckQuality -->|N√£o| ErrorQuality[Erro: Foto borrada<br/>ou muito escura]
    ErrorQuality --> SelectMethod
    
    CheckQuality -->|Sim| SendToDeepFace[Enviar para DeepFace API]
    SendToDeepFace --> VerifyFace{Reconhecido?<br/>Similaridade >= 60%}
    VerifyFace -->|N√£o| CheckAntiSpoof{Anti-spoofing:<br/>Foto real?}
    CheckAntiSpoof -->|Foto falsa| ErrorSpoof[Erro: Foto impressa<br/>ou tela detectada]
    ErrorSpoof --> SelectMethod
    CheckAntiSpoof -->|N√£o reconhecido| ErrorFace[Erro: Rosto n√£o reconhecido]
    ErrorFace --> SelectMethod
    
    VerifyFace -->|Sim| GetLocation[Obter geolocaliza√ß√£o]
    
    ScanFingerprint --> SendToSourceAFIS[Enviar para SourceAFIS]
    SendToSourceAFIS --> VerifyFingerprint{Match encontrado?}
    VerifyFingerprint -->|N√£o| ErrorFinger[Erro: Digital n√£o reconhecida]
    ErrorFinger --> SelectMethod
    VerifyFingerprint -->|Sim| GetLocation
    
    GetLocation --> CheckGeofence{Dentro da<br/>cerca virtual?}
    
    CheckGeofence -->|N√£o| WarningGeo[Aviso: Fora da √°rea<br/>permitida]
    WarningGeo --> ConfirmOutside{Confirmar registro<br/>mesmo assim?}
    ConfirmOutside -->|N√£o| SelectMethod
    ConfirmOutside -->|Sim| SavePunch
    
    CheckGeofence -->|Sim| SavePunch[Salvar marca√ß√£o<br/>no banco de dados]
    
    SavePunch --> GenerateNSR[Gerar NSR<br/>Sequencial]
    GenerateNSR --> GenerateHash[Gerar hash SHA-256]
    GenerateHash --> GenerateReceipt[Gerar comprovante<br/>eletr√¥nico]
    GenerateReceipt --> SendNotification[Enviar notifica√ß√£o<br/>e-mail/push]
    SendNotification --> ShowSuccess[Mensagem: Ponto<br/>registrado com sucesso]
    ShowSuccess --> End
```

### 2.3 Fluxograma - Cadastro de Reconhecimento Facial (DeepFace)

```mermaid
graph TB
    Start([Admin/Gestor inicia<br/>cadastro facial]) --> SelectEmployee[Selecionar<br/>funcion√°rio]
    
    SelectEmployee --> RequestConsent[Exibir termo de<br/>consentimento LGPD]
    
    RequestConsent --> EmployeeConsent{Funcion√°rio<br/>concorda?}
    
    EmployeeConsent -->|N√£o| CancelSetup[Cancelar cadastro<br/>facial]
    CancelSetup --> End([Retornar])
    
    EmployeeConsent -->|Sim| ShowInstructions[Instru√ß√µes:<br/>Boa ilumina√ß√£o<br/>Remover √≥culos/chap√©u<br/>Fundo neutro<br/>Rosto centralizado]
    
    ShowInstructions --> CapturePhoto[Capturar foto via<br/>webcam/upload]
    
    CapturePhoto --> PreviewPhoto[Preview da foto<br/>capturada]
    
    PreviewPhoto --> UserConfirm{Usu√°rio confirma<br/>qualidade?}
    UserConfirm -->|N√£o| CapturePhoto
    
    UserConfirm -->|Sim| UploadToServer[Upload para<br/>servidor PHP]
    
    UploadToServer --> ConvertBase64[Converter imagem<br/>para base64]
    
    ConvertBase64 --> SendDeepFace[POST /enroll para<br/>DeepFace API]
    
    SendDeepFace --> DeepFaceProcess[DeepFace:<br/>1. Detecta rosto<br/>2. Extrai features<br/>3. Salva embedding]
    
    DeepFaceProcess --> CheckResult{Cadastro<br/>bem-sucedido?}
    
    CheckResult -->|Erro: Sem rosto| ErrorNoFace[Erro: Nenhum rosto<br/>detectado na foto]
    ErrorNoFace --> CapturePhoto
    
    CheckResult -->|Erro: M√∫ltiplos| ErrorMultiple[Erro: M√∫ltiplos rostos<br/>Use foto individual]
    ErrorMultiple --> CapturePhoto
    
    CheckResult -->|Erro: Baixa qualidade| ErrorQuality[Erro: Foto muito<br/>escura ou borrada]
    ErrorQuality --> CapturePhoto
    
    CheckResult -->|Sucesso| SaveDB[Salvar refer√™ncia<br/>no MySQL]
    
    SaveDB --> LogConsent[Registrar consentimento<br/>LGPD com timestamp]
    
    LogConsent --> AuditLog[Registrar em<br/>audit_logs]
    
    AuditLog --> TestRecognition[Teste: Capturar nova<br/>foto para validar]
    
    TestRecognition --> RecognizeTest[POST /recognize para<br/>DeepFace API]
    
    RecognizeTest --> TestResult{Reconheceu<br/>corretamente?}
    
    TestResult -->|N√£o| WarningTest[Aviso: Reconhecimento<br/>pode n√£o funcionar bem]
    WarningTest --> ShowSuccess
    
    TestResult -->|Sim| ShowSuccess[Mensagem: Reconhecimento<br/>facial cadastrado!<br/>Similaridade: XX%]
    
    ShowSuccess --> End
```

### 2.4 Fluxograma - Sistema DeepFace API (Backend Python)

```mermaid
graph TB
    Start([Request HTTP chega]) --> CheckEndpoint{Qual endpoint?}
    
    CheckEndpoint -->|GET /health| HealthCheck[Retornar status: ok]
    HealthCheck --> End([Response JSON])
    
    CheckEndpoint -->|POST /enroll| ValidateEnroll[Validar payload:<br/>employee_id, photo]
    ValidateEnroll --> DecodeBase64[Decodificar base64<br/>para imagem]
    DecodeBase64 --> SaveTemp[Salvar arquivo<br/>tempor√°rio]
    SaveTemp --> DetectFace[DeepFace.extract_faces<br/>enforce_detection=True]
    
    DetectFace --> CountFaces{Quantos<br/>rostos?}
    CountFaces -->|0| ErrorNoFace[Error 400:<br/>Nenhum rosto detectado]
    CountFaces -->|> 1| ErrorMultiple[Error 400:<br/>M√∫ltiplos rostos]
    CountFaces -->|1| CreateDir[Criar diret√≥rio:<br/>/faces/employee_id/]
    
    CreateDir --> SaveFace[Salvar foto:<br/>employee_id_face.jpg]
    SaveFace --> GenerateEmbedding[DeepFace gera<br/>embedding autom√°tico]
    GenerateEmbedding --> SuccessEnroll[Success 200:<br/>Rosto cadastrado]
    
    ErrorNoFace --> End
    ErrorMultiple --> End
    SuccessEnroll --> End
    
    CheckEndpoint -->|POST /recognize| ValidateRecognize[Validar payload:<br/>photo, threshold]
    ValidateRecognize --> DecodePhoto[Decodificar base64]
    DecodePhoto --> SaveTempRecog[Salvar tempor√°rio]
    SaveTempRecog --> FindFace[DeepFace.find<br/>db_path=/faces/<br/>model=VGG-Face]
    
    FindFace --> CheckMatches{Encontrou<br/>matches?}
    
    CheckMatches -->|N√£o| NoMatch[Response:<br/>recognized: false]
    NoMatch --> CleanTemp
    
    CheckMatches -->|Sim| GetBestMatch[Pegar melhor match<br/>menor dist√¢ncia]
    GetBestMatch --> CheckThreshold{Dist√¢ncia <br/> threshold?}
    
    CheckThreshold -->|N√£o| NoMatch
    CheckThreshold -->|Sim| ExtractEmployeeId[Extrair employee_id<br/>do caminho do arquivo]
    
    ExtractEmployeeId --> CalcSimilarity[Calcular similaridade:<br/>1 - dist√¢ncia]
    CalcSimilarity --> SuccessRecognize[Response:<br/>recognized: true<br/>employee_id: XXX<br/>similarity: 0.XX]
    
    SuccessRecognize --> CleanTemp[Deletar arquivo<br/>tempor√°rio]
    CleanTemp --> End
    
    CheckEndpoint -->|POST /verify| VerifyProcess[Comparar duas fotos<br/>DeepFace.verify]
    VerifyProcess --> VerifyResult[Response:<br/>verified: bool<br/>distance: float<br/>similarity: float]
    VerifyResult --> End
    
    CheckEndpoint -->|POST /analyze| AnalyzeProcess[Analisar atributos<br/>DeepFace.analyze<br/>age, gender, emotion]
    AnalyzeProcess --> AnalyzeResult[Response:<br/>age: int<br/>gender: string<br/>emotion: string]
    AnalyzeResult --> End
```

### 2.5 Fluxograma - Justificativa de Aus√™ncia

```mermaid
graph TB
    Start([Funcion√°rio/Gestor<br/>acessa Justificativas]) --> SelectDate[Selecionar data<br/>da aus√™ncia]
    
    SelectDate --> SelectType{Tipo de<br/>justificativa}
    
    SelectType -->|Falta| FaltaForm[Formul√°rio de Falta]
    SelectType -->|Atraso| AtrasoForm[Formul√°rio de Atraso]
    SelectType -->|Sa√≠da Antecipada| SaidaForm[Formul√°rio de Sa√≠da]
    
    FaltaForm --> EnterReason[Inserir motivo<br/>detalhado]
    AtrasoForm --> EnterReason
    SaidaForm --> EnterReason
    
    EnterReason --> AttachFiles{Anexar<br/>documentos?}
    
    AttachFiles -->|Sim| UploadFiles[Upload de arquivos<br/>PDF, JPG, PNG]
    AttachFiles -->|N√£o| ValidateForm
    
    UploadFiles --> ValidateFiles{Arquivos v√°lidos?<br/>Max 5MB cada}
    ValidateFiles -->|N√£o| ErrorFile[Erro: Arquivo inv√°lido<br/>ou muito grande]
    ErrorFile --> AttachFiles
    ValidateFiles -->|Sim| ValidateForm
    
    ValidateForm{Formul√°rio<br/>completo?} -->|N√£o| ErrorForm[Erro: Preencher<br/>campos obrigat√≥rios]
    ErrorForm --> EnterReason
    
    ValidateForm -->|Sim| CheckRole{Quem est√°<br/>justificando?}
    
    CheckRole -->|Gestor| AutoApprove[Justificativa<br/>aprovada automaticamente]
    CheckRole -->|Funcion√°rio| PendingApproval[Justificativa<br/>pendente de aprova√ß√£o]
    
    AutoApprove --> SaveJustification[Salvar no banco<br/>de dados]
    PendingApproval --> NotifyManager[Notificar gestor<br/>para aprova√ß√£o]
    NotifyManager --> SaveJustification
    
    SaveJustification --> AuditLog[Registrar em<br/>audit log]
    AuditLog --> ShowSuccess[Mensagem: Justificativa<br/>enviada com sucesso]
    ShowSuccess --> End([Retornar])
```

### 2.6 Fluxograma - C√°lculo de Folha de Ponto

```mermaid
graph TB
    Start([Sistema executa<br/>c√°lculo di√°rio - CRON]) --> GetEmployees[Buscar todos<br/>funcion√°rios ativos]
    
    GetEmployees --> LoopEmployee{Para cada<br/>funcion√°rio}
    
    LoopEmployee --> GetPunches[Buscar marca√ß√µes<br/>do dia]
    
    GetPunches --> ValidatePairs{Marca√ß√µes<br/>pareadas?}
    
    ValidatePairs -->|N√£o| FlagIncomplete[Marcar como<br/>jornada incompleta]
    FlagIncomplete --> NotifyEmployee[Notificar funcion√°rio<br/>e gestor]
    NotifyEmployee --> LoopEmployee
    
    ValidatePairs -->|Sim| CalcTotal[Calcular total de<br/>horas trabalhadas]
    
    CalcTotal --> GetSchedule[Buscar jornada<br/>esperada do funcion√°rio]
    
    GetSchedule --> CalcDiff[Calcular diferen√ßa:<br/>Trabalhado - Esperado]
    
    CalcDiff --> CheckDiff{Diferen√ßa?}
    
    CheckDiff -->|Positiva| AddExtra[Adicionar a banco<br/>de horas positivo]
    CheckDiff -->|Negativa| CheckJustification{Possui<br/>justificativa?}
    CheckDiff -->|Zero| SaveNormal[Salvar jornada<br/>normal]
    
    CheckJustification -->|Sim| MarkJustified[Marcar como<br/>justificado]
    CheckJustification -->|N√£o| AddDebt[Adicionar a banco<br/>de horas negativo]
    
    AddExtra --> CheckBreaks[Validar intervalos<br/>obrigat√≥rios]
    MarkJustified --> CheckBreaks
    AddDebt --> CheckBreaks
    SaveNormal --> CheckBreaks
    
    CheckBreaks --> ValidateBreaks{Intervalos<br/>corretos?}
    
    ValidateBreaks -->|N√£o| FlagBreakViolation[Marcar viola√ß√£o<br/>de intervalo]
    FlagBreakViolation --> CalcPenalty[Calcular pagamento<br/>como hora extra 50%]
    CalcPenalty --> SaveRecord
    
    ValidateBreaks -->|Sim| SaveRecord[Salvar registro<br/>consolidado do dia]
    
    SaveRecord --> UpdateBalance[Atualizar saldo<br/>de horas acumulado]
    
    UpdateBalance --> LoopEmployee
    
    LoopEmployee -->|Fim| GenerateReports[Gerar relat√≥rios<br/>consolidados]
    
    GenerateReports --> End([Finalizar processo])
```

### 2.7 Fluxograma - Chat Interno (WebSocket)

```mermaid
graph TB
    Start([Usu√°rio abre<br/>Chat]) --> LoadContacts[Carregar lista<br/>de contatos]
    
    LoadContacts --> CheckRole{Verificar<br/>perfil}
    
    CheckRole -->|Admin| ShowAllUsers[Mostrar todos<br/>usu√°rios do sistema]
    CheckRole -->|Gestor| ShowTeam[Mostrar equipe<br/>e outros gestores]
    CheckRole -->|Funcion√°rio| ShowManagersAndPeers[Mostrar gestores<br/>e colegas]
    
    ShowAllUsers --> DisplayContacts[Exibir lista<br/>de contatos]
    ShowTeam --> DisplayContacts
    ShowManagersAndPeers --> DisplayContacts
    
    DisplayContacts --> UserAction{A√ß√£o do<br/>usu√°rio}
    
    UserAction -->|Selecionar contato| OpenChat[Abrir conversa<br/>com contato]
    UserAction -->|Buscar| SearchContact[Buscar por nome<br/>ou departamento]
    UserAction -->|Nova mensagem| SelectRecipient[Selecionar<br/>destinat√°rio]
    
    SearchContact --> DisplayContacts
    SelectRecipient --> OpenChat
    
    OpenChat --> LoadHistory[Carregar hist√≥rico<br/>de mensagens]
    LoadHistory --> EstablishWebSocket[Estabelecer conex√£o<br/>WebSocket]
    
    EstablishWebSocket --> CheckConnection{Conex√£o<br/>estabelecida?}
    CheckConnection -->|N√£o| FallbackPolling[Fallback para<br/>polling HTTP]
    CheckConnection -->|Sim| DisplayChat[Exibir interface<br/>de chat]
    FallbackPolling --> DisplayChat
    
    DisplayChat --> ChatLoop{Aguardar<br/>a√ß√£o}
    
    ChatLoop -->|Digitar mensagem| TypeMessage[Usu√°rio digita<br/>mensagem]
    ChatLoop -->|Receber mensagem| ReceiveMessage[Receber mensagem<br/>via WebSocket]
    ChatLoop -->|Anexar arquivo| AttachFile[Selecionar arquivo<br/>para anexar]
    
    TypeMessage --> SendButton{Pressionar<br/>Enviar?}
    SendButton -->|Sim| ValidateMessage{Mensagem<br/>n√£o vazia?}
    ValidateMessage -->|N√£o| ChatLoop
    ValidateMessage -->|Sim| SendViaWebSocket
    
    AttachFile --> ValidateFile{Arquivo v√°lido?<br/>Max 10MB}
    ValidateFile -->|N√£o| ErrorFile[Erro: Arquivo<br/>inv√°lido]
    ErrorFile --> ChatLoop
    ValidateFile -->|Sim| UploadFile[Upload do arquivo<br/>para servidor]
    UploadFile --> SendViaWebSocket
    
    SendViaWebSocket[Enviar via WebSocket] --> SaveMessage[Salvar mensagem<br/>no banco de dados]
    
    SaveMessage --> CheckRecipientOnline{Destinat√°rio<br/>online?}
    
    CheckRecipientOnline -->|Sim| DeliverWebSocket[Entregar via<br/>WebSocket]
    CheckRecipientOnline -->|N√£o| QueuePushNotification[Agendar notifica√ß√£o<br/>push]
    
    DeliverWebSocket --> MarkDelivered[Marcar como<br/>entregue]
    QueuePushNotification --> MarkDelivered
    
    MarkDelivered --> UpdateUI[Atualizar UI<br/>remetente]
    UpdateUI --> ChatLoop
    
    ReceiveMessage --> DisplayNewMessage[Exibir nova<br/>mensagem]
    DisplayNewMessage --> SendReadReceipt[Enviar confirma√ß√£o<br/>de leitura]
    SendReadReceipt --> PlayNotificationSound[Tocar som de<br/>notifica√ß√£o]
    PlayNotificationSound --> ChatLoop
    
    ChatLoop -->|Fechar chat| CloseWebSocket[Fechar conex√£o<br/>WebSocket]
    CloseWebSocket --> End([Retornar])
```

---

## 3. ESTRUTURA DO PROJETO

### 3.1 Estrutura de Diret√≥rios Completa

```
ponto-eletronico/
‚îú‚îÄ‚îÄ .env                          # Configura√ß√µes de ambiente
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ composer.json
‚îú‚îÄ‚îÄ composer.lock
‚îú‚îÄ‚îÄ README.md
‚îÇ
‚îú‚îÄ‚îÄ public/                       # Document root
‚îÇ   ‚îú‚îÄ‚îÄ index.php                 # Entry point
‚îÇ   ‚îú‚îÄ‚îÄ .htaccess
‚îÇ   ‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bootstrap.min.css
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ leaflet.css
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ custom.css
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ js/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bootstrap.bundle.min.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ leaflet.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ qrcode.min.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ socket.io.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ images/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ logo.png
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ icons/
‚îÇ
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ Config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ App.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Database.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Routes.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Validation.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Filters.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ICP.php              # Configura√ß√µes certificado ICP
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BaseController.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Auth/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LoginController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RegisterController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ LogoutController.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dashboard/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminDashboardController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ManagerDashboardController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ EmployeeDashboardController.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Timesheet/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TimePunchController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TimesheetController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ JustificationController.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Employee/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ EmployeeController.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Biometric/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FaceRecognitionController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ FingerprintController.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Geolocation/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ GeofenceController.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Report/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ReportController.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Chat/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ChatController.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Warning/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ WarningController.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Setting/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SettingController.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Api/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ApiController.php
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EmployeeModel.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TimePunchModel.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TimesheetModel.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JustificationModel.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BiometricTemplateModel.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GeofenceModel.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ReportModel.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ChatMessageModel.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WarningModel.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SettingModel.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UserConsentModel.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuditLogModel.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ NotificationModel.php
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Auth/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AuthService.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Biometric/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DeepFaceService.php         # NOVO
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SourceAFISService.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Geolocation/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LeafletService.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ NominatimService.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ICP/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ICPSignatureService.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ NSRGeneratorService.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Notification/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EmailService.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PushService.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SMSService.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Report/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PDFService.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ExcelService.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CSVService.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Queue/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ QueueService.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WebSocket/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ WebSocketService.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ LGPD/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ConsentService.php
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ DataExportService.php
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ DataAnonymizationService.php
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Filters/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthFilter.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminFilter.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ManagerFilter.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CorsFilter.php
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Libraries/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ QRCode/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ QRCodeGenerator.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Encryption/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ BiometricEncryption.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Validation/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ CPFValidator.php
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Views/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layouts/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ header.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ footer.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ register.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ manager.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ employee.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ timesheet/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ punch.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ history.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ justification.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ employee/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ list.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ edit.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ biometric/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ enroll_face.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ enroll_fingerprint.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ report/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ view.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ warning/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ view.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ index.php
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ Database/
‚îÇ       ‚îú‚îÄ‚îÄ Migrations/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ 2024_01_01_000001_create_employees_table.php
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ 2024_01_01_000002_create_time_punches_table.php
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ 2024_01_01_000003_create_biometric_templates_table.php
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ 2024_01_01_000004_create_justifications_table.php
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ 2024_01_01_000005_create_geofences_table.php
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ 2024_01_01_000006_create_chat_messages_table.php
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ 2024_01_01_000007_create_warnings_table.php
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ 2024_01_01_000008_create_user_consents_table.php
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ 2024_01_01_000009_create_audit_logs_table.php
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ 2024_01_01_000010_create_notifications_table.php
‚îÇ       ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ Seeds/
‚îÇ           ‚îú‚îÄ‚îÄ AdminUserSeeder.php
‚îÇ           ‚îî‚îÄ‚îÄ SettingsSeeder.php
‚îÇ
‚îú‚îÄ‚îÄ storage/
‚îÇ   ‚îú‚îÄ‚îÄ cache/
‚îÇ   ‚îú‚îÄ‚îÄ logs/
‚îÇ   ‚îú‚îÄ‚îÄ uploads/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ justifications/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ warnings/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ temp/
‚îÇ   ‚îú‚îÄ‚îÄ faces/                    # NOVO: banco de rostos DeepFace
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [employee_id]/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ face.jpg
‚îÇ   ‚îî‚îÄ‚îÄ keys/
‚îÇ       ‚îú‚îÄ‚îÄ biometric.key          # Chave para criptografia biom√©trica
‚îÇ       ‚îî‚îÄ‚îÄ icp/
‚îÇ           ‚îú‚îÄ‚îÄ certificate.pem    # Certificado ICP-Brasil
‚îÇ           ‚îî‚îÄ‚îÄ private.key        # Chave privada ICP
‚îÇ
‚îú‚îÄ‚îÄ vendor/                         # Depend√™ncias Composer
‚îÇ
‚îú‚îÄ‚îÄ deepface-api/                   # NOVO: Microservi√ßo Python
‚îÇ   ‚îú‚îÄ‚îÄ venv/                       # Ambiente virtual Python
‚îÇ   ‚îú‚îÄ‚îÄ app.py                      # API Flask
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îî‚îÄ‚îÄ config.py
‚îÇ
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ install.sh                 # Script de instala√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ worker.php                 # Worker para processar filas
‚îÇ   ‚îú‚îÄ‚îÄ cron_calculate.php         # Cron para c√°lculo de jornada
‚îÇ   ‚îú‚îÄ‚îÄ websocket_server.php       # Servidor WebSocket
‚îÇ   ‚îú‚îÄ‚îÄ deepface_start.sh          # NOVO: Iniciar DeepFace API
‚îÇ   ‚îî‚îÄ‚îÄ backup.sh                  # Script de backup
‚îÇ
‚îî‚îÄ‚îÄ tests/
    ‚îú‚îÄ‚îÄ unit/
    ‚îú‚îÄ‚îÄ integration/
    ‚îî‚îÄ‚îÄ e2e/
```

---

## 4. COMANDOS CLAUDE CODE POR FASE

### 4.1 FASE 0: POC - Proof of Concept (Semana 1) üÜï

**Comando 0.1: Validar DeepFace localmente**

```bash
claude code "Crie POC de valida√ß√£o do DeepFace. Instale ambiente Python virtual, instale deepface via pip, crie script test_deepface.py que: 1) Cadastra 3 fotos de teste em /test/faces/, 2) Testa reconhecimento com foto id√™ntica (deve retornar >95% similaridade), 3) Testa com foto diferente (deve retornar <60%), 4) Testa anti-spoofing com foto de tela/impressa, 5) Mede tempo de resposta (target <2s), 6) Gera relat√≥rio JSON com resultados. Inclua tratamento de erros e valida√ß√£o de acur√°cia m√≠nima 90%."
```

**Comando 0.2: Prot√≥tipo interface de ponto**

```bash
claude code "Crie prot√≥tipo HTML puro da interface de registro de ponto. Single page com: 1) Bot√£o grande 'BATER PONTO' centralizado, 2) Timer mostrando hora atual atualizado a cada segundo, 3) √öltimas 5 marca√ß√µes em lista, 4) Seletor de m√©todo (C√≥digo/QR/Facial), 5) Preview de webcam ao selecionar Facial, 6) Bot√£o de captura de foto, 7) Feedback visual de sucesso/erro. Use Bootstrap 5 e JavaScript vanilla. Deve funcionar offline (localStorage para cache)."
```

### 4.2 FASE 1: Setup Inicial (Semana 2-3)

**Comando 1.1: Criar estrutura base do projeto**

```bash
claude code "Crie a estrutura completa do projeto de ponto eletr√¥nico seguindo exatamente a estrutura de diret√≥rios especificada. Use CodeIgniter 4 como framework. Configure composer.json com depend√™ncias: codeigniter4/shield (autentica√ß√£o), phpoffice/phpspreadsheet (Excel), tecnickcom/tcpdf (PDF), guzzlehttp/guzzle (HTTP requests), chillerlan/php-qrcode (QR Code). Crie todos os diret√≥rios necess√°rios. Configure .env.example com vari√°veis: DB_*, APP_*, DEEPFACE_API_URL."
```

**Comando 1.2: Configurar banco de dados e migrations**

```bash
claude code "Configure o sistema de migrations do CodeIgniter 4. Crie todas as 10 migrations listadas. Cada migration deve ter: tipos de dados adequados para MySQL 8.0, √≠ndices compostos para queries frequentes (employee_id+punch_time), foreign keys com ON DELETE CASCADE, campos created_at/updated_at com default CURRENT_TIMESTAMP, coment√°rios explicativos em cada campo sens√≠vel. Tabelas: employees, time_punches, biometric_templates, justifications, geofences, chat_messages, warnings, user_consents, audit_logs, notifications."
```

**Comando 1.3: Criar seeders para dados iniciais**

```bash
claude code "Crie seeders para popular dados iniciais. AdminUserSeeder: cria admin@ponto.com.br com senha 'Admin@123' usando PASSWORD_ARGON2ID, CPF 111.111.111-11 (fake mas v√°lido), perfil 'admin', active=true. SettingsSeeder: hor√°rio expediente (08:00-18:00), intervalo obrigat√≥rio 1h para >6h, raio cerca virtual 100m, max upload 5MB, DEEPFACE_THRESHOLD=0.40, notifica√ß√µes habilitadas. Use transactions para garantir atomicidade."
```

### 4.3 FASE 2: Setup DeepFace API (Semana 4) üÜï

**Comando 2.1: Criar microservi√ßo DeepFace**

```bash
claude code "Crie microservi√ßo DeepFace API em Python. Estrutura: deepface-api/app.py com Flask, endpoints GET /health, POST /enroll, POST /recognize, POST /verify, POST /analyze. Implemente: 1) Valida√ß√£o de payload com jsonschema, 2) Decodifica√ß√£o base64 segura, 3) Limite de tamanho de imagem (5MB), 4) Detec√ß√£o de m√∫ltiplos rostos (erro se >1), 5) Anti-spoofing b√°sico, 6) Logging estruturado com timestamp/level/message, 7) CORS habilitado apenas para dom√≠nio configurado, 8) Rate limiting (100 req/min por IP). Use DeepFace modelo VGG-Face (padr√£o). Crie requirements.txt: flask==3.0.0, deepface==0.0.89, gunicorn==21.2.0, Pillow==10.1.0, flask-cors==4.0.0, flask-limiter==3.5.0."
```

**Comando 2.2: Configurar DeepFace como servi√ßo systemd**

```bash
claude code "Crie configura√ß√£o para rodar DeepFace API como servi√ßo systemd. Arquivo deepface-api.service em /etc/systemd/system/ com: User=www-data, WorkingDirectory=/var/www/deepface-api, ExecStart usando gunicorn com 2 workers, Restart=always, RestartSec=10, EnvironmentFile=/var/www/deepface-api/.env. Crie script scripts/deepface_start.sh que: 1) Verifica se venv existe, 2) Ativa ambiente virtual, 3) Instala/atualiza depend√™ncias se requirements.txt mudou, 4) Inicia gunicorn na porta 5000. Adicione healthcheck: curl localhost:5000/health a cada 30s, restart se falhar 3 vezes."
```

**Comando 2.3: Integra√ß√£o PHP com DeepFace**

```bash
claude code "Crie DeepFaceService.php em app/Services/Biometric/. Implementar m√©todos: 1) healthCheck(): bool - GET /health com timeout 5s, 2) enrollFace(int $employeeId, string $photoPath): array - converte imagem para base64, POST /enroll, retorna success/error, 3) recognizeFace(string $photoPath, float $threshold=0.40): array - POST /recognize, retorna recognized/employee_id/similarity, 4) verifyFace(string $photo1, string $photo2): array - POST /verify, 5) analyzeFace(string $photoPath): array - POST /analyze. Usar Guzzle HTTP client com: timeout 30s, retry 3x com exponential backoff (1s, 2s, 4s), logging de todas requests/responses, tratamento espec√≠fico de HTTP 400/500/timeout. Adicionar cache de 5min para recognize() com mesmo hash de foto."
```

### 4.4 FASE 3: Autentica√ß√£o e Perfis (Semana 5-6)

**Comando 3.1: Implementar sistema de autentica√ß√£o**

```bash
claude code "Implemente sistema de autentica√ß√£o usando CodeIgniter 4 Shield. LoginController: valida√ß√£o email/senha, prote√ß√£o brute force (5 tentativas = bloqueio 15min), hash Argon2id, sessions com regenera√ß√£o de ID ap√≥s login. RegisterController: valida√ß√£o CPF √∫nico (regex + checksum d√≠gito verificador), e-mail √∫nico, senha m√≠nima 8 chars (mai√∫scula+min√∫scula+n√∫mero+especial), confirma√ß√£o de senha. Criar 3 perfis em tabela groups: 'admin' (id=1, all permissions), 'gestor' (id=2, manage employees, approve justifications), 'funcionario' (id=3, clock in/out, view own data). AuthFilter: verificar login antes de cada request exceto /auth/*. AdminFilter e ManagerFilter: verificar grupo espec√≠fico."
```

**Comando 3.2: Criar dashboards espec√≠ficos por perfil**

```bash
claude code "Crie tr√™s dashboards distintos com Bootstrap 5: 1) AdminDashboard: cards com totais (funcion√°rios ativos, marca√ß√µes hoje, pend√™ncias), gr√°fico de linha (marca√ß√µes √∫ltimos 7 dias) com Chart.js, lista de alertas (saldos negativos, certificados expirando, consentimentos pendentes), atalhos r√°pidos para configura√ß√µes/relat√≥rios. 2) ManagerDashboard: card com resumo da equipe, tabela de pend√™ncias de justificativas (nome, data, tipo, a√ß√£o aprovar/rejeitar), calend√°rio mensal com presen√ßas/faltas da equipe usando FullCalendar.js, bot√£o 'Bater Ponto'. 3) EmployeeDashboard: bot√£o grande 'BATER PONTO' (verde se pode bater, cinza se fora do hor√°rio), card com resumo do m√™s (horas trabalhadas/esperadas/saldo), lista das √∫ltimas 10 marca√ß√µes, link para justificar falta. Todos responsivos mobile-first."
```

### 4.5 FASE 4: Registro de Ponto Core (Semana 7-8)

**Comando 4.1: Implementar registro de ponto b√°sico**

```bash
claude code "Implemente TimePunchController com m√©todos: 1) index(): renderiza view com interface de registro, carrega configura√ß√µes de hor√°rio permitido do banco. 2) punch(): valida se dentro do hor√°rio permitido (tolerance ¬±15min), detecta tipo de marca√ß√£o (entrada/sa√≠da/intervalo-in√≠cio/intervalo-fim) baseado em √∫ltimo registro do funcion√°rio, gera NSR sequencial global √∫nico (SELECT MAX(nsr) + 1 com lock), calcula hash SHA-256 de (employee_id + punch_type + punch_time + nsr), salva em time_punches com geolocaliza√ß√£o se fornecida. Valida√ß√µes: n√£o permitir marca√ß√µes com <1 minuto de intervalo, verificar se j√° n√£o bateu 4 pontos no dia (entrada, sa√≠da intervalo, volta intervalo, sa√≠da). TimePunchModel: getLastPunch($employeeId, $date), generateNSR(), calculateHash($data)."
```

**Comando 4.2: Adicionar gera√ß√£o de comprovante eletr√¥nico**

```bash
claude code "Implemente gera√ß√£o de comprovante PDF conforme Portaria 671/2021 usando TCPDF. M√©todo generateReceipt($punchId) em TimePunchController: 1) Buscar dados da marca√ß√£o, funcion√°rio e empresa, 2) Criar PDF A4 portrait, 3) Cabe√ßalho: logo empresa (se existir), raz√£o social, CNPJ, endere√ßo, 4) Corpo: t√≠tulo 'COMPROVANTE DE REGISTRO DE PONTO ELETR√îNICO', dados do funcion√°rio (nome, CPF, matr√≠cula), data/hora da marca√ß√£o formatada (dd/mm/yyyy HH:mm:ss), tipo de marca√ß√£o (ENTRADA/SA√çDA/INTERVALO-IN√çCIO/INTERVALO-FIM), NSR com 10 d√≠gitos zero-padded, hash SHA-256 em fonte monospace, 5) QR Code contendo JSON: {nsr, employee_id, punch_time, hash} para valida√ß√£o, 6) Rodap√©: 'Registro INPI: [n√∫mero]', link para valida√ß√£o online, assinatura digital ICP-Brasil (se certificado configurado). Salvar PDF em storage/receipts/YYYY/MM/employee_id_nsr.pdf. Retornar link de download."
```

### 4.6 FASE 5: Registro por C√≥digo e QR (Semana 9)

**Comando 5.1: Implementar registro por c√≥digo √∫nico**

```bash
claude code "Adicione registro por c√≥digo √∫nico. Ao criar funcion√°rio em EmployeeModel, gerar c√≥digo alfanum√©rico √∫nico de 8 caracteres: bin2hex(random_bytes(4)). Salvar em campo 'unique_code' com √≠ndice √∫nico. TimePunchController->punchByCode($code): 1) Buscar funcion√°rio ativo com c√≥digo, 2) Se n√£o encontrado, retornar erro 404 'C√≥digo inv√°lido', 3) Se encontrado, processar registro normal. Interface: input de 8 caracteres com m√°scara autom√°tica (XXXX-XXXX), valida√ß√£o em tempo real via AJAX (endpoint /api/validate-code), bot√£o confirmar habilitado apenas quando c√≥digo v√°lido (resposta HTTP 200), feedback visual (borda verde=v√°lido, vermelho=inv√°lido, amarelo=validando). Adicionar exibi√ß√£o do c√≥digo no perfil do funcion√°rio com bot√£o 'Copiar' e QR Code para salvar no celular."
```

**Comando 5.2: Implementar registro por QR Code**

```bash
claude code "Implemente sistema de QR Code usando chillerlan/php-qrcode. EmployeeModel: adicionar m√©todo generateQRCode(): 1) Criar payload JSON: {employee_id, unique_code, generated_at, signature}, 2) Signature √© HMAC-SHA256(payload, APP_KEY), 3) Gerar QR Code n√≠vel corre√ß√£o L, tamanho 400x400px, 4) Salvar PNG em storage/qrcodes/employee_id.png, 5) Retornar path. TimePunchController->punchByQR(): 1) Receber payload via POST, 2) Validar assinatura HMAC, 3) Verificar se generated_at n√£o est√° expirado (max 5 minutos para seguran√ßa), 4) Buscar funcion√°rio, 5) Processar registro. Frontend: bot√£o 'Ler QR Code', usar biblioteca html5-qrcode (https://github.com/mebjas/html5-qrcode) para abrir c√¢mera, detectar QR, enviar payload via AJAX. P√°gina de visualiza√ß√£o do QR do funcion√°rio: exibir QR em tela cheia, bot√£o 'Baixar PNG', bot√£o 'Imprimir', texto 'V√°lido por 5 minutos ap√≥s gera√ß√£o'."
```

### 4.7 FASE 6: Integra√ß√£o Reconhecimento Facial (Semana 10-11) üîÑ ATUALIZADO

**Comando 6.1: Controller de cadastro facial**

```bash
claude code "Crie FaceRecognitionController->enroll(). Fluxo: 1) Validar upload de foto (max 5MB, mime types: image/jpeg, image/png), 2) Exibir termo de consentimento LGPD antes de processar (checkbox obrigat√≥rio), 3) Salvar foto temporariamente em storage/temp/, 4) Chamar DeepFaceService->enrollFace($employeeId, $tempPath), 5) Se sucesso: salvar refer√™ncia em biometric_templates (biometric_type='face', template_hash=hash SHA256 da foto, enrollment_quality=100, active=true), registrar consentimento em user_consents (consent_type='biometric_face', purpose='Registro de ponto eletr√¥nico', granted=true, granted_at=NOW(), ip_address=REMOTE_ADDR), registrar em audit_logs (action='ENROLL_FACE'), limpar arquivo tempor√°rio, 6) Se erro: retornar mensagem espec√≠fica (sem rosto, m√∫ltiplos rostos, qualidade baixa), manter arquivo para debug por 24h. Interface: instru√ß√µes visuais (boa ilumina√ß√£o, remover √≥culos, centralizar rosto), preview de webcam, bot√£o 'Capturar', preview da foto capturada, bot√£o 'Confirmar' ou 'Tentar Novamente'."
```

**Comando 6.2: Implementar registro de ponto facial**

```bash
claude code "Adicione TimePunchController->punchByFace(). Fluxo: 1) Receber foto via POST (base64 ou upload), 2) Salvar temporariamente, 3) Chamar DeepFaceService->recognizeFace($tempPath, threshold=0.40), 4) Se recognized=false: retornar erro 'Rosto n√£o reconhecido. Tente novamente ou use outro m√©todo', 5) Se recognized=true: buscar funcion√°rio pelo employee_id retornado, validar se est√° ativo, processar registro de ponto normalmente, salvar similarity score no campo face_similarity de time_punches, 6) Limpar arquivo tempor√°rio. Adicionar rate limiting espec√≠fico: m√°ximo 5 tentativas de reconhecimento facial por minuto por IP (usar CodeIgniter Throttler). Interface: bot√£o 'Reconhecimento Facial', abrir webcam fullscreen, mostrar c√≠rculo guia para posicionar rosto, capturar automaticamente quando detectar rosto centralizado, loading com mensagem 'Reconhecendo...' (pode levar 2-3s), feedback de sucesso com nome do funcion√°rio reconhecido e % de similaridade."
```

**Comando 6.3: Teste de reconhecimento ap√≥s cadastro**

```bash
claude code "Adicione m√©todo FaceRecognitionController->test($employeeId). Ap√≥s cadastrar rosto, executar teste autom√°tico: 1) Solicitar nova foto (diferente da cadastrada), 2) Chamar recognizeFace(), 3) Verificar se reconheceu corretamente o employee_id, 4) Exibir resultado: SE reconheceu corretamente: 'Teste bem-sucedido! Similaridade: XX%', SE n√£o reconheceu: 'AVISO: Reconhecimento falhou no teste. Tente cadastrar novamente com foto de melhor qualidade', SE reconheceu pessoa errada: 'ERRO CR√çTICO: Sistema reconheceu outra pessoa. Cadastro cancelado.'. Registrar resultado do teste em audit_logs. Se teste falhar 2x seguidas, desabilitar reconhecimento facial para este funcion√°rio e notificar admin."
```

### 4.8 FASE 7: Geolocaliza√ß√£o (Semana 12)

**Comando 7.1: Implementar captura de geolocaliza√ß√£o**

```bash
claude code "Crie arquivo public/assets/js/geolocator.js usando HTML5 Geolocation API. Fun√ß√£o requestLocation(): 1) navigator.geolocation.getCurrentPosition() com options={enableHighAccuracy: true, timeout: 10000, maximumAge: 0}, 2) onSuccess: retornar {lat, lng, accuracy}, 3) onError: se PERMISSION_DENIED, mostrar modal explicando necessidade e como habilitar, se TIMEOUT, tentar novamente (max 3 tentativas), se POSITION_UNAVAILABLE, permitir registro sem localiza√ß√£o mas alertar. Integrar com formul√°rio de ponto: ao clicar 'Bater Ponto', primeiro capturar localiza√ß√£o (loading 'Obtendo localiza√ß√£o...'), depois enviar junto com m√©todo de registro. Backend TimePunchController: adicionar campos opcionais location_lat, location_lng, location_accuracy em valida√ß√£o, salvar se fornecidos. Se accuracy > 100m, adicionar warning 'Precis√£o de GPS baixa (¬±XXXm). Localiza√ß√£o pode estar imprecisa'."
```

**Comando 7.2: Implementar cerca virtual (geofencing)**

```bash
claude code "Crie GeofenceModel e GeofenceController CRUD. Campos: name (varchar 100), center_lat (decimal 10,8), center_lng (decimal 11,8), radius_meters (int), active (boolean), created_by (FK employees). GeofenceService->checkGeofence($lat, $lng): 1) Buscar todas cercas ativas, 2) Para cada cerca, calcular dist√¢ncia usando f√≥rmula de Haversine: a = sin¬≤(ŒîœÜ/2) + cos œÜ1 ‚ãÖ cos œÜ2 ‚ãÖ sin¬≤(ŒîŒª/2), c = 2 ‚ãÖ atan2(‚àöa, ‚àö(1‚àía)), d = R ‚ãÖ c (R=6371km), 3) Se dist√¢ncia <= radius_meters para qualquer cerca, retornar true + nome da cerca, sen√£o false. TimePunchController->punch(): antes de salvar, chamar checkGeofence(), salvar resultado no campo within_geofence (boolean) e geofence_name (varchar nullable). Se fora da cerca, exibir modal 'Voc√™ est√° fora da √°rea permitida (Dist√¢nciaXXXm). Deseja registrar mesmo assim?' com bot√µes Cancelar/Confirmar. Registros fora da cerca devem ter flag visual diferente (√≠cone warning) nos relat√≥rios."
```

**Comando 7.3: Interface de mapa com Leaflet**

```bash
claude code "Crie views/geofence/map.php usando Leaflet.js. Interface: 1) Mapa fullscreen com tiles OpenStreetMap, 2) Centralizar em coordenadas da empresa (do Settings), zoom 15, 3) Desenhar c√≠rculo azul semi-transparente para cada cerca ativa (L.circle()), com popup mostrando nome e raio, 4) Bot√£o 'Nova Cerca': ao clicar, permitir clicar no mapa para definir centro (L.marker() arrast√°vel), slider para ajustar raio (50-500m) com preview do c√≠rculo, input para nome, bot√£o Salvar, 5) Lista lateral de cercas: card para cada uma com nome, endere√ßo aproximado (usar Nominatim reverse geocoding), raio, bot√µes Editar/Excluir, 6) Layer de marca√ß√µes de ponto dos √∫ltimos 7 dias: pins verdes (dentro da cerca), pins vermelhos (fora), ao clicar no pin mostrar popup (funcion√°rio, data/hora, dist√¢ncia da cerca mais pr√≥xima). Adicionar controle de camadas (Leaflet.Control.Layers) para mostrar/ocultar cercas e marca√ß√µes."
```

### 4.9 FASE 8: Justificativas (Semana 13)

**Comando 8.1: CRUD de justificativas**

```bash
claude code "Crie JustificationController e JustificationModel. CRUD completo: 1) create(): formul√°rio com campos tipo (select: falta, atraso, sa√≠da-antecipada), date (datepicker, n√£o permitir futuro), motivo (textarea 500 chars, obrigat√≥rio), categoria (select: doen√ßa, compromisso-pessoal, emerg√™ncia-familiar, outro), upload m√∫ltiplo de arquivos (max 3, tipos permitidos: PDF, JPG, PNG, max 5MB cada). 2) store(): validar campos, salvar arquivos em storage/uploads/justifications/YYYY/MM/employee_id/, salvar registro no banco com status='pendente' se funcion√°rio ou 'aprovado' se gestor, registrar em audit_logs. 3) list(): para funcion√°rio, mostrar apenas suas justificativas; para gestor, mostrar todas da equipe com filtros (data, tipo, status, funcion√°rio); para admin, todas do sistema. 4) approve($id): apenas gestor/admin, alterar status para 'aprovado', adicionar campo approved_by e approved_at, enviar e-mail para funcion√°rio. 5) reject($id): alterar status para 'rejeitado', adicionar campo rejection_reason (obrigat√≥rio), enviar e-mail. Interface: tabela responsiva com DataTables, filtros din√¢micos, modal para visualizar anexos, badges coloridos para status (pendente=amarelo, aprovado=verde, rejeitado=vermelho)."
```

### 4.10 FASE 9: C√°lculo de Folha (Semana 14-15)

**Comando 9.1: Worker de c√°lculo di√°rio**

```bash
claude code "Crie scripts/cron_calculate.php executado via cron todo dia √†s 00:30. Algoritmo: 1) Buscar todos funcion√°rios ativos, 2) Para cada um: buscar marca√ß√µes do dia anterior, 3) Validar pareamento: entrada‚Üísa√≠da, intervalo-in√≠cio‚Üíintervalo-fim, 4) Se incompleto: marcar flag incomplete=true, n√£o calcular, notificar funcion√°rio e gestor, 5) Se completo: calcular total trabalhado = Œ£(sa√≠da - entrada) - Œ£(intervalo), 6) Buscar jornada esperada (do cadastro do funcion√°rio ou padr√£o 8h), 7) Diferen√ßa = trabalhado - esperado, 8) Se diferen√ßa > 0: extra_hours_balance += diferen√ßa, 9) Se diferen√ßa < 0: buscar justificativa aprovada para data, SE tem: marcar justified=true, N√ÉO descontar, SE n√£o tem: owed_hours_balance += |diferen√ßa|, 10) Validar intervalos: jornada >6h deve ter >=1h de intervalo, jornada 4-6h deve ter >=15min, 11) Se violou intervalo: calcular pagamento = tempo_violado * 1.5, adicionar a interval_violation_hours, 12) Salvar registro em timesheet_consolidated (employee_id, date, total_worked, expected, extra, owed, interval_violation, justified). Enviar e-mail di√°rio para funcion√°rio com resumo. Usar transactions. Logging detalhado."
```

**Comando 9.2: Dashboard de saldo de horas**

```bash
claude code "Crie views/timesheet/balance.php. Interface: 1) Card destaque com saldo atual de horas: SE positivo: fundo verde, √≠cone ‚Üë, 'Banco de Horas: +XX:XX', SE negativo: fundo vermelho, √≠cone ‚Üì, 'Horas Devidas: -XX:XX', SE zero: fundo azul, 'Em Dia', 2) Gr√°fico de linha (Chart.js) mostrando evolu√ß√£o do saldo nos √∫ltimos 30/60/90 dias (tabs), eixo Y em horas, linha verde para valores positivos, vermelha para negativos, 3) Tabela detalhada com colunas: Data, Entrada, Sa√≠da, Intervalos, Total Trabalhado, Esperado, Diferen√ßa, Justificado (√≠cone ‚úì/‚úó), A√ß√µes (visualizar comprovantes), 4) Filtros: per√≠odo (√∫ltima semana/m√™s/ano/personalizado), apenas dias com irregularidades (checkbox), 5) Alertas: SE saldo negativo > 10h: banner vermelho 'Aten√ß√£o: Voc√™ possui XXh em d√©bito', SE saldo positivo > 40h: banner amarelo 'Voc√™ possui XXh acumuladas. Solicite compensa√ß√£o'. Bot√µes: 'Exportar PDF', 'Exportar Excel', 'Solicitar Compensa√ß√£o'. Para gestor, adicionar dropdown para selecionar funcion√°rio da equipe."
```

### 4.11 FASE 10: Relat√≥rios (Semana 16-17)

**Comando 10.1: Engine de gera√ß√£o de relat√≥rios**

```bash
claude code "Crie ReportController com m√©todos: 1) index(): p√°gina com formul√°rio de gera√ß√£o, selects para tipo de relat√≥rio (folha-ponto, horas-extras, faltas-atrasos, banco-horas, consolidado-mensal, justificativas, advert√™ncias, personalizado), filtros din√¢micos (funcion√°rio multi-select com Select2, departamento, per√≠odo date range picker, status), bot√£o 'Gerar Relat√≥rio'. 2) generate(): processar filtros, chamar m√©todo espec√≠fico do tipo, SE resultado > 10.000 linhas: adicionar a queue para processamento em background, retornar job_id e polling status; SEN√ÉO: gerar imediatamente. 3) M√©todos por tipo: generateTimesheetReport($filters), generateOvertimeReport($filters), etc. Cada um: monta query com filtros, busca dados do banco, formata arrays, retorna dados + metadata (total_records, filters_applied, generated_at). 4) format($data, $format): SE 'html': renderizar view com tabela e gr√°ficos, SE 'pdf': chamar PDFService, SE 'excel': chamar ExcelService, SE 'csv': chamar CSVService, SE 'json': retornar JSON puro. Implementar cache de 1h para relat√≥rios id√™nticos (hash de filtros como chave Redis/File)."
```

**Comando 10.2: Servi√ßos de exporta√ß√£o**

```bash
claude code "Crie tr√™s servi√ßos: 1) PDFService->generateReport($type, $data): usar TCPDF, adicionar cabe√ßalho (logo empresa, t√≠tulo do relat√≥rio, filtros aplicados, data de gera√ß√£o), tabela formatada com colunas apropriadas ao tipo, rodap√© (p√°gina X de Y, gerado por Sistema de Ponto v1.0), SE certificado ICP configurado: assinar PDF digitalmente usando OpenSSL (fun√ß√£o openssl_pkcs7_sign), salvar em storage/reports/YYYY/MM/. 2) ExcelService->generateReport($type, $data): usar PhpSpreadsheet, criar aba 'Resumo' com totais e filtros, aba 'Detalhes' com dados tabulares, aplicar formata√ß√£o condicional (verde para positivos, vermelho para negativos), adicionar autofilter nas colunas, f√≥rmulas de soma no rodap√©, SE dados incluem s√©ries temporais: criar aba 'Gr√°ficos' com chart de linha/barra. 3) CSVService->generateReport($type, $data): formato simples, delimiter ponto-v√≠rgula (compatibilidade Excel Brasil), encoding UTF-8 com BOM, cabe√ßalho com nomes de colunas, escaping correto de aspas/quebras de linha. Todos: retornar path do arquivo gerado."
```

### 4.12 FASE 11: Chat Interno (Semana 18)

**Comando 11.1: Servidor WebSocket**

```bash
claude code "Crie scripts/websocket_server.php usando workerman/workerman. Configurar: porta 8080, workers=4. Eventos: 1) onWorkerStart: inicializar array de conex√µes por usu√°rio, 2) onConnect: aguardar autentica√ß√£o (enviar {type:'auth_required'}), 3) onMessage: PARSE JSON, SE type='auth': validar JWT token, armazenar user_id na conex√£o, broadcast {type:'user_online', user_id} para contatos, SE type='message': validar destinat√°rio, salvar em chat_messages (sender_id, recipient_id, message, sent_at), SE destinat√°rio online: enviar via WebSocket, SEN√ÉO: queue notifica√ß√£o push, enviar confirma√ß√£o para remetente {type:'message_sent', message_id}, SE type='typing': broadcast para destinat√°rio {type:'user_typing', user_id}, SE type='read': atualizar read_at em chat_messages, enviar confirma√ß√£o para remetente, 4) onClose: broadcast {type:'user_offline', user_id} para contatos, remover conex√£o. Adicionar heartbeat a cada 30s (ping/pong) para detectar conex√µes mortas. Logging de todas mensagens. Configurar como daemon usando supervisord ou systemd."
```

**Comando 11.2: Interface de chat**

```bash
claude code "Crie views/chat/index.php. Layout: sidebar esquerda (250px) + √°rea de conversa (flex-grow). Sidebar: input de busca (filtrar por nome), lista de contatos (foto circular 40px, nome, √∫ltimo status online/offline com badge verde/cinza, √∫ltima mensagem truncada 30 chars, timestamp relativo '5 min atr√°s'), ordenar por √∫ltima atividade. √Årea de conversa: cabe√ßalho (foto+nome do contato, status online/offline), hist√≥rico de mensagens (scroll autom√°tico para √∫ltima, mensagens do usu√°rio √† direita com fundo azul, do contato √† esquerda com fundo cinza, timestamp em fonte pequena, indicador de leitura check simples/duplo), input de mensagem (textarea auto-expand at√© 5 linhas, bot√£o emoji picker usando emoji-picker-element, bot√£o anexo, bot√£o enviar, contador de caracteres max 5000). JavaScript: conectar WebSocket ao carregar, autenticar com JWT do localStorage, escutar eventos, atualizar UI em tempo real, som de notifica√ß√£o ao receber mensagem (apenas se janela n√£o est√° em foco), indicador 'digitando...' com debounce de 1s. Fallback: se WebSocket falhar, usar polling a cada 5s via AJAX."
```

### 4.13 FASE 12: Advert√™ncias (Semana 19)

**Comando 12.1: Sistema de advert√™ncias**

```bash
claude code "Crie WarningController e WarningModel. Campos: employee_id, warning_type (enum: verbal, escrita, suspensao), date, reason (text), evidence_files (json array de paths), issued_by (FK employees), employee_signature (text nullable), employee_signed_at (datetime nullable), witness_signature (text nullable para recusas), status (enum: pendente-assinatura, assinado, recusado). M√©todos: 1) create(): formul√°rio para gestor/admin com tipo, data da ocorr√™ncia, motivo detalhado (min 50 chars), upload de evid√™ncias (opcional, max 5 arquivos 10MB), 2) store(): salvar registro, gerar PDF com template formal (cabe√ßalho empresa, t√≠tulo 'ADVERT√äNCIA [TIPO]', dados do funcion√°rio, descri√ß√£o dos fatos, cl√°usulas legais, espa√ßo para assinatura), assinar PDF digitalmente com ICP-Brasil do emissor, enviar notifica√ß√£o para funcion√°rio com link para assinar, status='pendente-assinatura', 3) sign($id): funcion√°rio visualiza PDF, aceita termos, adiciona assinatura digital (certificado pr√≥prio ICP ou assinatura eletr√¥nica simplificada via c√≥digo SMS), atualizar employee_signed_at, gerar PDF final com ambas assinaturas, status='assinado', 4) refuseSignature($id): ap√≥s 48h sem assinatura, gestor adiciona testemunha (nome, CPF, assinatura), status='recusado'. Dashboard de advert√™ncias: timeline visual das advert√™ncias do funcion√°rio, contador (X/3 advert√™ncias), alerta autom√°tico ao atingir 3¬™."
```

### 4.14 FASE 13: LGPD (Semana 20)

**Comando 13.1: Gest√£o de consentimentos**

```bash
claude code "Crie ConsentService e views/lgpd/consents.php. Portal de consentimentos: listar todos consentimentos do funcion√°rio (biometric_face, biometric_fingerprint, geolocation, data_processing), para cada: checkbox granted/revoked, descri√ß√£o da finalidade (ex: 'Reconhecimento facial para registro de ponto eletr√¥nico e controle de acesso'), base legal (LGPD Art. 11, II - cumprimento de obriga√ß√£o legal), data de concess√£o, bot√£o 'Revogar'. Modal de consentimento: exibir texto completo do termo, checkbox 'Li e concordo', bot√£o Aceitar (disabled at√© marcar checkbox), bot√£o Recusar. ConsentService->grant($userId, $type): salvar em user_consents (consent_type, purpose, granted=true, granted_at=NOW(), ip_address, user_agent), registrar em audit_logs. ConsentService->revoke($userId, $type): atualizar revoked_at, SE type='biometric_face': deletar arquivo de foto em storage/faces/, desabilitar em biometric_templates, SE type='biometric_fingerprint': deletar template criptografado, SE type='geolocation': parar de coletar localiza√ß√£o nos pr√≥ximos registros. Notificar admin de revoga√ß√µes. Gerar relat√≥rio de consentimentos para ANPD: CSV com user_id anonimizado, tipo, data concess√£o, data revoga√ß√£o, finalidade."
```

**Comando 13.2: Portabilidade de dados**

```bash
claude code "Crie DataExportService->exportUserData($userId). Processo: 1) Coletar dados: perfil (employees), marca√ß√µes (time_punches), justificativas (justifications), mensagens (chat_messages enviadas/recebidas), advert√™ncias (warnings), configura√ß√µes (user_preferences), consentimentos (user_consents), 2) Para dados biom√©tricos: gerar hash SHA-256 ao inv√©s de dados raw, 3) Estruturar JSON-LD: {'@context': 'http://schema.org', '@type': 'Person', 'identifier': 'USER-XXX', 'personalData': {...}, 'activityData': {...}, 'metadata': {exportDate, systemVersion}}, 4) Comprimir em ZIP, 5) Criptografar ZIP com senha gerada aleatoriamente (8 chars alfanum√©ricos), 6) Salvar em storage/exports/user_XXX_TIMESTAMP.zip, 7) Enviar e-mail para funcion√°rio com link de download (v√°lido 24h, token √∫nico) e senha em e-mail separado, 8) Registrar exporta√ß√£o em audit_logs, 9) Auto-deletar arquivo ap√≥s 48h (cron). Interface: bot√£o 'Solicitar Portabilidade de Dados' no perfil, modal explicativo 'Voc√™ receber√° por e-mail um arquivo contendo todos os seus dados em formato leg√≠vel por m√°quina (JSON). Prazo: at√© 15 dias conforme LGPD Art. 19'. Status da solicita√ß√£o: pendente/processando/conclu√≠da/expirada."
```

**Comando 13.3: Auditoria e Logs**

```bash
claude code "Implemente sistema robusto de audit logs. Criar trait Auditable em app/Traits/ que pode ser usado em qualquer Model. Trait sobrescreve: afterInsert($data): registrar CREATE, afterUpdate($id, $data): buscar valores antigos, registrar UPDATE com old_values e new_values em JSON, afterDelete($id, $purge): buscar dados do registro, registrar DELETE com old_values. AuditLogModel: campos user_id, action (CREATE/UPDATE/DELETE/VIEW/EXPORT/LOGIN/LOGOUT), entity_type (nome da tabela), entity_id, old_values (JSON nullable), new_values (JSON nullable), ip_address (varchar 45 para IPv6), user_agent (text), url (varchar 255), created_at. M√©todos: log($action, $entity, $data), getByUser($userId, $filters), getByEntity($type, $id), search($filters). Views/audit/index.php: dashboard administrativo com filtros (usu√°rio select2, a√ß√£o multi-select, entidade, per√≠odo), tabela com DataTables server-side processing, export para CSV/Excel, timeline visual das a√ß√µes de um usu√°rio, alertas para a√ß√µes suspeitas (ex: 100+ a√ß√µes em 1 minuto = poss√≠vel script/bot). Reten√ß√£o: manter logs por 10 anos (conformidade fiscal + LGPD), particionamento de tabela por ano."
```

### 4.15 FASE 14: Configura√ß√µes (Semana 21)

**Comando 14.1: Painel de configura√ß√µes**

```bash
claude code "Crie SettingController->index() com interface administrativa completa usando tabs Bootstrap. Tabs: 1) Geral: inputs para nome_empresa, cnpj (m√°scara), logo (upload, preview), cores tema (color pickers para prim√°ria/secund√°ria), timezone (select), 2) Jornada: hor√°rio_expediente_inicio/fim (time pickers), intervalo_obrigat√≥rio_horas (number, step 0.25), toler√¢ncia_minutos_atraso (number), dias_√∫teis (checkboxes Seg-Dom), 3) Geolocaliza√ß√£o: toggle ativar/desativar obrigatoriedade, CRUD de cercas incorporado (tabela + modal), 4) Notifica√ß√µes: toggles para email/push/sms, lembrete_ponto_minutos_antes (number), templates de e-mail edit√°veis (TinyMCE), 5) Biometria: input DEEPFACE_API_URL, DEEPFACE_THRESHOLD (slider 0.30-0.70, padr√£o 0.40), modelo (select VGG-Face/Facenet/ArcFace), toggle anti-spoofing, 6) APIs: Nominatim custom endpoint, rate limits, cache TTL, 7) ICP-Brasil: upload certificado .pfx, input senha (encrypted), exibir validade e dias restantes, bot√£o testar assinatura, 8) LGPD: input nome_dpo, email_dpo, pol√≠tica de reten√ß√£o (30 dias a 10 anos por tipo de dado), 9) Backup: configurar S3 (access key, secret, bucket, region) ou FTP (host, user, pass, path), agendamento (di√°rio/semanal), reten√ß√£o de backups. Cada se√ß√£o com bot√£o 'Salvar' independente. Validar cada campo, salvar em tabela settings (key, value criptografado com APP_KEY), cache de 1h, invalidar ao salvar."
```

**Comando 14.2: Dashboard administrativo**

```bash
claude code "Crie views/dashboard/admin.php rico em informa√ß√µes. Grid responsivo com Bootstrap: Linha 1 - Cards de resumo (4 colunas): total funcion√°rios ativos (n√∫mero grande, √≠cone users, link para /employees), marca√ß√µes hoje (n√∫mero, √≠cone clock, link para relat√≥rio do dia), pend√™ncias totais (justificativas aguardando + advert√™ncias n√£o assinadas, √≠cone bell, link para pend√™ncias), saldo m√©dio de horas da empresa (positivo=verde, negativo=vermelho, √≠cone chart-bar). Linha 2 - Gr√°fico de linha (8 colunas): evolu√ß√£o de marca√ß√µes √∫ltimos 30 dias (Chart.js Line, eixo X datas, eixo Y quantidade, tooltip mostrando detalhes) + Gr√°fico de pizza (4 colunas): distribui√ß√£o por departamento (Chart.js Pie, cores distintas, legend). Linha 3 - Mapa de calor (12 colunas): hor√°rios de maior movimento (heatmap.js, eixo X horas 00-23, eixo Y dias Seg-Dom, cor mais intensa = mais marca√ß√µes). Linha 4 - Alertas (6 colunas): lista de cards com √≠cones, jornadas incompletas hoje (vermelho), saldos negativos cr√≠ticos >20h (amarelo), consentimentos LGPD pendentes (azul), certificados ICP expirando <30 dias (laranja); cada alerta clic√°vel leva para a√ß√£o espec√≠fica + Atividade recente (6 colunas): √∫ltimas 10 a√ß√µes do audit_logs (timestamp relativo, usu√°rio, a√ß√£o, entidade). Linha 5 - Atalhos r√°pidos (12 colunas): bot√µes grandes para cadastrar funcion√°rio, gerar relat√≥rio, abrir configura√ß√µes, visualizar logs. Rodap√© - Status dos servi√ßos: badges verde/vermelho para MySQL (testar conex√£o), DeepFace API (GET /health), WebSocket (check porta 8080). Auto-atualizar cards via AJAX a cada 30s."
```

### 4.16 FASE 15: Testes (Semana 22-24) üîÑ ESTENDIDO

**Comando 15.1: Suite de testes unit√°rios**

```bash
claude code "Implemente testes unit√°rios usando PHPUnit. Criar tests/unit/ com: 1) AuthServiceTest: testLoginValid() (credenciais corretas retorna user), testLoginInvalid() (credenciais erradas retorna false), testPasswordHash() (Argon2id funciona), testBruteForceProtection() (5 tentativas bloqueia por 15min), 2) TimePunchModelTest: testCalculateHours() (entrada 08:00 sa√≠da 12:00 = 4h), testValidatePairing() (entrada sem sa√≠da = incompleto), testGenerateNSR() (NSR sempre √∫nico e sequencial), 3) GeofenceServiceTest: testHaversineDistance() (dist√¢ncia entre duas coordenadas conhecidas), testCheckGeofence() (dentro retorna true, fora retorna false), 4) DeepFaceServiceTest: mockear responses da API, testEnrollSuccess(), testEnrollNoFace(), testRecognizeSuccess(), testRecognizeNoMatch(), 5) ConsentServiceTest: testGrant() (salva corretamente), testRevoke() (deleta dados biom√©tricos). Configurar bootstrap.php para ambiente de teste, usar banco de dados separado 'ponto_test', migrations antes de cada test suite, truncate tables depois. Target: >80% code coverage. Rodar via ./vendor/bin/phpunit, gerar relat√≥rio HTML de coverage."
```

**Comando 15.2: Testes de integra√ß√£o**

```bash
claude code "Criar tests/integration/ para fluxos completos: 1) TimePunchFlowTest: setupEmployee() cria funcion√°rio, testFullPunchCycle() simula entrada‚Üíintervalo-in√≠cio‚Üíintervalo-fim‚Üísa√≠da, valida cada registro no banco, verifica c√°lculo de horas, 2) JustificationFlowTest: testCreateAndApprove() funcion√°rio cria justificativa com anexo, gestor aprova, verifica status e notifica√ß√£o, testCreateAndReject() gestor rejeita com motivo, 3) FaceRecognitionFlowTest: testEnrollAndRecognize() cadastra rosto (upload foto fake), tenta reconhecer com mesma foto (deve passar), tenta com foto diferente (deve falhar), mockear DeepFace API com respostas pr√©-definidas, 4) ReportGenerationTest: testGenerateTimesheetPDF() cria marca√ß√µes fake, gera relat√≥rio, verifica arquivo PDF existe e n√£o est√° vazio, testGenerateExcel() valida estrutura do XLSX. Usar DatabaseMigration trait para reset de banco entre testes. Configurar fixtures com dados realistas (faker)."
```

**Comando 15.3: Testes E2E com Selenium**

```bash
claude code "Setup Selenium WebDriver para testes end-to-end. Instalar via Composer: php-webdriver/webdriver. Criar tests/e2e/: 1) LoginE2ETest: setUp() inicia ChromeDriver, testLoginFlow() abre http://localhost/login, preenche email/senha, clica Login, aguarda redirect para dashboard, verifica presen√ßa de 'Bem-vindo', tearDown() fecha browser, 2) PunchE2ETest: testClockInByCode() loga como funcion√°rio, clica 'Bater Ponto', seleciona 'C√≥digo', digita c√≥digo v√°lido, clica Confirmar, aguarda mensagem de sucesso, verifica registro no banco, 3) JustificationE2ETest: testCreateJustification() loga como funcion√°rio, navega para Justificativas, clica Nova, preenche formul√°rio, anexa arquivo, submete, verifica aparece na lista. Configurar headless mode para CI/CD (--headless --disable-gpu). Tirar screenshots em caso de falha para debug. Rodar em ambiente de staging separado. Estes testes s√£o lentos, rodar apenas em pre-deploy."
```

**Comando 15.4: Testes de carga**

```bash
claude code "Configurar testes de carga com Apache Bench. Criar scripts/load_test.sh: 1) Endpoint /api/punch (simular 100 funcion√°rios batendo ponto simultaneamente): ab -n 1000 -c 50 -p punch_payload.json -T application/json -H 'Authorization: Bearer TOKEN' http://localhost/api/punch, validar 95% das requests <500ms, 0% falhas, 2) Endpoint /recognize (reconhecimento facial): ab -n 100 -c 10 -p recognize_payload.json http://localhost:5000/recognize, validar 95% <2s (processar foto √© lento), 3) WebSocket (chat): simular 50 conex√µes simult√¢neas enviando mensagens, medir lat√™ncia (target <100ms), 4) Gera√ß√£o de relat√≥rio grande (10k linhas): ab -n 20 -c 5, validar n√£o causa timeout ou memory limit. Usar Apache Bench (ab) ou Locust (Python) para testes mais avan√ßados. Monitorar uso de RAM/CPU durante testes (htop). Rodar em VPS de staging id√™ntico ao produ√ß√£o. Gerar relat√≥rio: requests/s, tempo m√©dio, percentis (50%, 90%, 95%, 99%), erros."
```

**Comando 15.5: Testes de seguran√ßa**

```bash
claude code "Executar testes de seguran√ßa automatizados: 1) OWASP ZAP Scan: docker run -t owasp/zap2docker-stable zap-baseline.py -t http://localhost, analisa vulnerabilidades comuns (XSS, SQLi, CSRF), gera relat√≥rio HTML, 2) SQLMap: testar endpoints com par√¢metros de busca, sqlmap -u 'http://localhost/api/employees/search?q=test' --level=3 --risk=2 --batch, verificar se detecta SQL injection (deve retornar 0), 3) Nikto: nikto -h http://localhost -C all, scan de configura√ß√µes inseguras do servidor, 4) Manual: testar CSRF token ausente (submeter form sem token = erro 403), testar rate limiting (fazer 101 requests em 1 minuto para /api/recognize = bloqueio), testar acesso n√£o autorizado (tentar acessar /admin sem login = redirect 302). Target: 0 vulnerabilidades cr√≠ticas ou altas. Corrigir todas m√©dias. Documentar baixas como 'risco aceito' se aplic√°vel."
```

**Comando 15.6: POC de Reconhecimento Facial em Produ√ß√£o** üÜï

```bash
claude code "Criar POC final de reconhecimento facial com dados reais antes de deploy. Script tests/poc/facial_recognition_poc.php: 1) Cadastrar 5 funcion√°rios volunt√°rios reais, 2) Para cada um: capturar 3 fotos em condi√ß√µes diferentes (manh√£, tarde, noite; com/sem √≥culos; dist√¢ncias 30cm, 50cm, 1m), 3) Testar reconhecimento com cada foto, registrar taxa de acerto (target >90%), 4) Testar fotos falsas: imprimir foto do funcion√°rio, tirar foto da impress√£o, tentar reconhecer (anti-spoofing deve bloquear), foto de tela (celular mostrando foto), 5) Testar com pessoas n√£o cadastradas (deve retornar 'n√£o reconhecido'), 6) Medir tempos de resposta (cadastro, reconhecimento), 7) Gerar relat√≥rio CSV: funcion√°rio, condi√ß√£o, reconhecido (sim/n√£o), similaridade, tempo_ms. SE taxa de acerto <85%: ajustar threshold ou considerar modelo diferente (Facenet, ArcFace). Executar em ambiente de staging com DeepFace real."
```

### 4.17 FASE 16: Otimiza√ß√µes (Semana 25)

**Comando 16.1: Otimiza√ß√µes de banco de dados**

```bash
claude code "Implementar otimiza√ß√µes cr√≠ticas de banco: 1) Adicionar √≠ndices compostos: ALTER TABLE time_punches ADD INDEX idx_employee_date (employee_id, punch_time DESC); ALTER TABLE audit_logs ADD INDEX idx_user_action_date (user_id, action, created_at DESC); ALTER TABLE chat_messages ADD INDEX idx_sender_recipient_date (sender_id, recipient_id, sent_at DESC), 2) Criar view para relat√≥rios frequentes: CREATE VIEW v_monthly_timesheet AS SELECT e.id, e.name, DATE_FORMAT(tp.punch_time, '%Y-%m') as month, SUM(TIMESTAMPDIFF(HOUR, ...) as total_hours FROM..., 3) Particionar tabela time_punches por ano: ALTER TABLE time_punches PARTITION BY RANGE (YEAR(punch_time)) (PARTITION p2024 VALUES LESS THAN (2025), PARTITION p2025 VALUES LESS THAN (2026), ...), 4) Habilitar query cache: SET GLOBAL query_cache_size = 1048576; SET GLOBAL query_cache_type = ON, 5) Configurar MySQL para otimiza√ß√£o: innodb_buffer_pool_size = 1G (50-70% da RAM), max_connections = 200, slow_query_log = ON (queries >1s). Rodar EXPLAIN em queries cr√≠ticas para validar uso de √≠ndices. Benchmark antes/depois com script SQL."
```

**Comando 16.2: Otimiza√ß√µes de aplica√ß√£o**

```bash
claude code "Implementar otimiza√ß√µes de aplica√ß√£o: 1) Eager loading: em EmployeeModel, criar m√©todo getWithRelations() que usa JOIN ao inv√©s de m√∫ltiplas queries, Model::select('employees.*, departments.name as dept_name')->join('departments', ...)->find(), evitar N+1 em listagens, 2) Cache de configura√ß√µes: criar ConfigService->get($key) que busca do cache primeiro (CodeIgniter cache file/Redis), TTL 1h, invalidar ao atualizar settings, 3) Pagination: em todas listagens, usar CodeIgniter pagination com 50 itens/p√°gina, nunca carregar mais de 1000 registros sem pagina√ß√£o, 4) Lazy loading de imagens: adicionar classe .lazy em <img>, usar Intersection Observer para carregar apenas imagens vis√≠veis, 5) Minificar assets: configurar webpack ou usar CodeIgniter Asset Pipeline, minify CSS/JS, combinar m√∫ltiplos arquivos, versioning para cache busting, 6) Compress√£o Gzip: adicionar ao .htaccess AddOutputFilterByType DEFLATE text/html text/css application/javascript, 7) OPcache PHP: adicionar ao php.ini opcache.enable=1, opcache.memory_consumption=256, opcache.max_accelerated_files=20000. Medir com Chrome DevTools Network tab, target: Time to Interactive <3s."
```

**Comando 16.3: Cache de reconhecimento facial** üÜï

```bash
claude code "Implementar cache inteligente para reconhecimento facial. FacialRecognitionCache: 1) Ap√≥s reconhecimento bem-sucedido, salvar cache com chave=hash_sha256(foto), valor={employee_id, similarity, timestamp}, TTL=5 minutos (evitar reconhecer mesma foto repetidamente), 2) Antes de chamar DeepFace API, verificar se hash da foto est√° em cache, SE sim e timestamp <5min: retornar do cache (economiza ~2s), SE n√£o: chamar API e cachear resultado, 3) Invalidar cache ao: alterar foto cadastrada do funcion√°rio, desativar funcion√°rio, 4) Implementar LRU (Least Recently Used) para limitar cache a 1000 entradas (mem√≥ria ~10MB). Usar Redis se dispon√≠vel, sen√£o File cache. Adicionar m√©trica ao dashboard admin: 'Cache hit rate: XX%'. Tamb√©m cachear resultado de 'n√£o reconhecido' para evitar tentativas repetidas com mesma foto inv√°lida (limite 10 tentativas de foto n√£o reconhecida por IP em 1h)."
```

### 4.18 FASE 17: Documenta√ß√£o e Deploy (Semana 26)

**Comando 17.1: Documenta√ß√£o completa**

```bash
claude code "Criar documenta√ß√£o completa: 1) README.md raiz: introdu√ß√£o do projeto, features principais (autentica√ß√£o, ponto por c√≥digo/QR/facial, geolocaliza√ß√£o, relat√≥rios, chat, LGPD), requisitos (PHP 8.1+, MySQL 8.0+, Python 3.8+, 4GB RAM), badges (build status, coverage, version), links para docs/ e INSTALL.md, 2) INSTALL.md detalhado: a) Requisitos: servidor Linux Ubuntu 22.04, Apache/Nginx, PHP 8.1 com extens√µes (mbstring, intl, gd, curl, mysqli, sodium), MySQL 8.0, Python 3.8+, b) Passo a passo: clonar repo, composer install, configurar .env (copiar de .example, gerar APP_KEY), criar banco, rodar migrations e seeders, configurar vhost Apache/Nginx, permiss√µes writable/ e storage/ (chmod 775, chown www-data), setup Python: criar venv, pip install -r deepface-api/requirements.txt, configurar systemd para DeepFace e WebSocket, c) Configura√ß√£o ICP-Brasil opcional, d) Testes: rodar PHPUnit, verificar /health endpoints, 3) docs/API.md: documenta√ß√£o OpenAPI 3.0 de todos endpoints REST, exemplos de request/response curl, autentica√ß√£o via Bearer token, rate limits, c√≥digos de erro, 4) docs/LGPD.md: bases legais usadas, direitos dos titulares (acesso, corre√ß√£o, portabilidade, elimina√ß√£o), procedimentos de resposta a solicita√ß√µes (prazos, formatos), DPO contato, 5) TROUBLESHOOTING.md: problemas comuns (DeepFace n√£o inicia: verificar Python version, Face n√£o reconhece: ajustar threshold, WebSocket desconecta: check firewall), 6) CHANGELOG.md: hist√≥rico de vers√µes semver."
```

**Comando 17.2: Script de deploy automatizado**

```bash
claude code "Criar scripts/deploy.sh para deploy automatizado em produ√ß√£o. Script bash: 1) Verificar pr√©-requisitos: git, composer, npm, python3, mysql-client, 2) Modo de deploy: --production flag obrigat√≥rio para produ√ß√£o, 3) Backup antes de deploy: mysqldump banco em backups/pre-deploy_$(date +%Y%m%d_%H%M%S).sql, tar de storage/ e vendor/, 4) Git: stash local changes, pull origin main, verificar se pull foi sucesso, 5) Depend√™ncias: composer install --no-dev --optimize-autoloader (produ√ß√£o sem dev dependencies), npm install && npm run build (minify assets), 6) Migra√ß√µes: php spark migrate --force (sem confirma√ß√£o), verificar exit code, SE falhou: rollback com backup, 7) Cache: limpar todos caches (php spark cache:clear, opcache_reset()), 8) Reiniciar servi√ßos: systemctl restart deepface-api, systemctl restart websocket, systemctl reload php8.1-fpm (n√£o restart para evitar downtime), systemctl reload nginx, 9) Healthcheck: curl /health de cada servi√ßo (app, DeepFace, WebSocket), SE algum falhou: rollback e alertar, 10) Logs: registrar deploy em logs/deploy.log (timestamp, version/commit, user, status success/failed), enviar notifica√ß√£o Slack/email, 11) Rollback autom√°tico: SE qualquer etapa falhar, restaurar backup e reverter git. Adicionar flag --dry-run para testar sem executar."
```

**Comando 17.3: CI/CD com GitHub Actions**

```bash
claude code "Configurar CI/CD com GitHub Actions. Criar .github/workflows/ci.yml: 1) Trigger: on push to branches main/develop e pull_requests, 2) Jobs: a) test: steps [checkout code, setup PHP 8.1, setup Python 3.8, composer install, pip install deepface, copy .env.testing, php spark migrate --env=testing, phpunit com coverage, upload coverage to Codecov], b) lint: steps [PHP-CS-Fixer para PSR-12, ESLint para JavaScript, Pylint para Python], c) security: steps [composer audit (vulnerabilidades), npm audit, safety check para Python deps], 3) Artifacts: salvar reports de coverage, logs de testes, 4) Notifica√ß√£o: status check verde/vermelho no PR, coment√°rio autom√°tico com % coverage se <80%, 5) Deploy workflow separado (.github/workflows/deploy.yml): on push to main (apenas!), steps [SSH to production server, run deploy.sh, healthcheck, rollback if failed]. Configurar secrets no GitHub: SSH_PRIVATE_KEY, PRODUCTION_HOST, DEPLOY_USER, SLACK_WEBHOOK. Adicionar badge de build status ao README."
```

---

## 5. PROMPTS DETALHADOS

### 5.1 Prompt para Desenvolvimento Full-Stack

```
Voc√™ √© um desenvolvedor full-stack especialista criando um sistema de ponto eletr√¥nico para empresas brasileiras. 

CONTEXTO:
- Framework: CodeIgniter 4
- Conformidade: Portaria MTE 671/2021, CLT, LGPD
- Stack: PHP 8.1+, MySQL 8.0+, JavaScript ES6+, Bootstrap 5
- Biometria: DeepFace (Python) via API REST - SEM DOCKER
- Arquitetura: MVC, RESTful API, WebSocket para chat
- Integra√ß√µes: DeepFace API (facial), SourceAFIS (fingerprint opcional), OpenStreetMap

DIRETRIZES DE C√ìDIGO:
1. Seguran√ßa:
   - Usar prepared statements (SEMPRE)
   - Escapar output com htmlspecialchars()
   - Validar e sanitizar TODOS inputs
   - Implementar CSRF tokens
   - Hash senhas com PASSWORD_ARGON2ID
   - Criptografar dados biom√©tricos com Sodium

2. Performance:
   - Usar √≠ndices em queries frequentes
   - Eager loading para evitar N+1
   - Cache de configura√ß√µes (1h) e reconhecimentos faciais (5min)
   - Pagination em listagens
   - Lazy loading de imagens

3. LGPD:
   - Registrar consentimentos com timestamp
   - Permitir revoga√ß√£o a qualquer momento
   - Implementar exporta√ß√£o de dados (JSON)
   - Anonimizar ao deletar usu√°rio
   - Audit log de TODAS a√ß√µes sens√≠veis

4. DeepFace Integration:
   - Health check antes de usar (GET /health timeout 5s)
   - Timeout 30s em reconhecimentos
   - Retry 3x com exponential backoff
   - Cache de reconhecimentos (hash da foto como chave)
   - Threshold padr√£o 0.40 (ajust√°vel)
   - Sempre validar response.success antes de usar dados

5. C√≥digo Limpo:
   - Nomes descritivos de vari√°veis/fun√ß√µes
   - Coment√°rios em l√≥gicas complexas
   - Maximum 200 linhas por m√©todo
   - PSR-12 coding standard
   - Type hints em PHP 8.1+

6. Testes:
   - Unit tests para l√≥gica de neg√≥cio
   - Integration tests para fluxos
   - Mock de APIs externas (DeepFace)
   - Coverage m√≠nimo 80%

TAREFA:
[INSERIR TAREFA ESPEC√çFICA AQUI]

ENTREG√ÅVEIS:
- C√≥digo funcional e testado
- Coment√°rios explicativos
- Exemplo de uso
- Tratamento de erros robusto
```

### 5.2 Prompt para Debugging

```
Voc√™ √© um especialista em debugging e an√°lise de c√≥digo PHP/Python.

SITUA√á√ÉO:
[DESCREVER O BUG/ERRO]

C√ìDIGO ATUAL:
[COLAR C√ìDIGO COM PROBLEMA]

LOGS DE ERRO:
[COLAR LOGS]

CONTEXTO DO SISTEMA:
- PHP 8.1 + CodeIgniter 4
- Python 3.8 + DeepFace + Flask
- MySQL 8.0
- VPS Ubuntu 22.04

AN√ÅLISE NECESS√ÅRIA:
1. Identificar a causa raiz do problema
2. Explicar POR QUE o erro est√° ocorrendo
3. Propor solu√ß√£o(√µes) com c√≥digo corrigido
4. Sugerir testes para validar a corre√ß√£o
5. Recomendar melhorias para evitar problemas similares

FORMATO DE RESPOSTA:
## Causa Raiz
[Explica√ß√£o clara]

## Solu√ß√£o
```php
[C√≥digo corrigido]
```

## Testes
[Como testar a corre√ß√£o]

## Preven√ß√£o
[Melhores pr√°ticas para evitar este tipo de problema]
```

---

## 6. TESTES E VALIDA√á√ÉO

### 6.1 Checklist de Testes

**Reconhecimento Facial (DeepFace)** üÜï
- [ ] DeepFace API responde a health check
- [ ] Cadastro de rosto com foto v√°lida (1 rosto, boa qualidade)
- [ ] Rejei√ß√£o de foto sem rosto
- [ ] Rejei√ß√£o de foto com m√∫ltiplos rostos
- [ ] Reconhecimento com similaridade >80%
- [ ] N√£o reconhecimento com similaridade <40%
- [ ] Anti-spoofing detecta foto impressa
- [ ] Anti-spoofing detecta foto de tela
- [ ] Cache de reconhecimento funciona (hash de foto)
- [ ] Tempo de resposta <3s (incluindo network)
- [ ] Retry funciona em caso de timeout
- [ ] Graceful fallback se DeepFace est√° offline

**Autentica√ß√£o e Autoriza√ß√£o**
- [ ] Login com credenciais v√°lidas
- [ ] Login com credenciais inv√°lidas (3 tentativas = bloqueio)
- [ ] Registro de novo usu√°rio com valida√ß√µes
- [ ] Perfis (Admin/Gestor/Funcion√°rio) com permiss√µes corretas
- [ ] Logout e invalida√ß√£o de sess√£o
- [ ] Prote√ß√£o de rotas via filtros

**Registro de Ponto**
- [ ] Registro por c√≥digo √∫nico v√°lido
- [ ] Registro por QR Code v√°lido
- [ ] Registro por reconhecimento facial (>80% similaridade)
- [ ] Registro por biometria digital (match)
- [ ] Bloqueio fora do hor√°rio permitido
- [ ] Valida√ß√£o de intervalo m√≠nimo entre marca√ß√µes (1 min)
- [ ] Gera√ß√£o de NSR sequencial √∫nico
- [ ] Gera√ß√£o de hash SHA-256 correto
- [ ] Comprovante eletr√¥nico em PDF
- [ ] Notifica√ß√£o por e-mail

**Geolocaliza√ß√£o**
- [ ] Captura de coordenadas com precis√£o
- [ ] Valida√ß√£o de cerca virtual (dentro/fora)
- [ ] Registro permitido mesmo fora da cerca (com flag)
- [ ] Visualiza√ß√£o de mapa com Leaflet
- [ ] Cadastro de m√∫ltiplas cercas
- [ ] C√°lculo correto de dist√¢ncia Haversine

[... resto do checklist igual ao plano anterior ...]

### 6.2 Testes de Carga

```bash
# Instalar Apache Bench
sudo apt install apache2-utils

# Testar endpoint de login (100 requests, 10 concurrent)
ab -n 100 -c 10 -p login.json -T application/json https://ponto.empresa.com.br/api/auth/login

# Testar registro de ponto (1000 requests, 50 concurrent)
ab -n 1000 -c 50 -H "Authorization: Bearer TOKEN" https://ponto.empresa.com.br/api/punch

# Testar reconhecimento facial (100 requests, 10 concurrent) üÜï
ab -n 100 -c 10 -p face_payload.json -T application/json http://localhost:5000/recognize

# Target: 95% das requests < 500ms (punch), < 2s (face recognition)
```

---

## 7. COMANDOS √öTEIS PARA DESENVOLVIMENTO

### 7.1 Setup Ambiente Local

```bash
# Clone do projeto
git clone https://github.com/empresa/ponto-eletronico.git
cd ponto-eletronico

# Instalar depend√™ncias PHP
composer install
npm install

# Configurar .env
cp env.example .env
nano .env  # Editar DATABASE, DEEPFACE_API_URL, etc

# Gerar chave de aplica√ß√£o
php spark key:generate

# Criar banco de dados
mysql -u root -p -e "CREATE DATABASE ponto_eletronico CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# Rodar migrations
php spark migrate

# Rodar seeders
php spark db:seed AdminUserSeeder
php spark db:seed SettingsSeeder

# Setup DeepFace API (Python) üÜï
cd deepface-api
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
python app.py  # Porta 5000

# Iniciar servidor de desenvolvimento PHP (terminal separado)
cd ..
php spark serve --port=8000

# Iniciar WebSocket server (terminal separado)
php scripts/websocket_server.php

# Compilar assets
npm run build

# Verificar se tudo est√° OK
curl http://localhost:8000  # App principal
curl http://localhost:5000/health  # DeepFace API
# Ambos devem retornar 200 OK
```

### 7.2 Comandos de Desenvolvimento

```bash
# Criar nova migration
php spark make:migration create_nova_tabela_table

# Criar novo model
php spark make:model NovoModel

# Criar novo controller
php spark make:controller NovoController

# Rodar testes
./vendor/bin/phpunit

# Rodar testes com coverage
./vendor/bin/phpunit --coverage-html coverage/

# Limpar cache
php spark cache:clear

# Ver rotas dispon√≠veis
php spark routes

# Gerar documenta√ß√£o da API
php spark api:docs

# Backup do banco
php spark db:backup

# Restaurar backup
php spark db:restore backup_2024_01_15.sql

# Testar DeepFace API üÜï
curl http://localhost:5000/health
curl -X POST http://localhost:5000/enroll \
  -H "Content-Type: application/json" \
  -d '{"employee_id":"123","photo":"BASE64_HERE"}'
```

### 7.3 Comandos de Produ√ß√£o

```bash
# Deploy automatizado
./scripts/deploy.sh --production

# Verificar logs
tail -f storage/logs/log-$(date +%Y-%m-%d).log
tail -f deepface-api/logs/app.log  # DeepFace logs üÜï

# Verificar status dos servi√ßos
systemctl status nginx
systemctl status php8.1-fpm
systemctl status mysql
systemctl status deepface-api  # üÜï
systemctl status websocket

# Reiniciar DeepFace API üÜï
systemctl restart deepface-api

# Reiniciar WebSocket
systemctl restart websocket

# Processar fila de jobs
php scripts/worker.php

# Rodar c√°lculo de jornada (cron di√°rio)
php scripts/cron_calculate.php

# Monitorar performance
htop

# Verificar uso de disco
df -h

# Verificar conex√µes MySQL
mysql -e "SHOW PROCESSLIST;"

# Monitorar DeepFace API üÜï
curl http://localhost:5000/health
ps aux | grep gunicorn
```

---

## 8. COMPARA√á√ÉO: PLANO V1.0 vs V2.0

| Aspecto | V1.0 (CompreFace) | V2.0 (DeepFace) |
|---------|-------------------|-----------------|
| **Docker necess√°rio** | ‚úÖ Sim (obrigat√≥rio) | ‚ùå N√£o |
| **Instala√ß√£o** | docker-compose up | pip install deepface |
| **RAM m√≠nima** | 4 GB | 400 MB |
| **VPS m√≠nimo** | ‚Ç¨8.99/m√™s | ‚Ç¨4.99/m√™s |
| **Setup complexity** | Alta | Baixa |
| **Manuten√ß√£o** | Docker + containers | Python simples |
| **Acur√°cia** | 99.56% | 99.65% |
| **Anti-spoofing** | ‚ùå N√£o | ‚úÖ Sim |
| **Modelos dispon√≠veis** | 2 | 8 |
| **Shared hosting** | ‚ùå Imposs√≠vel | ‚ö†Ô∏è VPS necess√°rio |
| **Tempo de reconhecimento** | 2-3s | 1-2s |
| **Escalabilidade** | Complexa | Simples (gunicorn workers) |
| **Custo anual** | ~‚Ç¨108 VPS | ~‚Ç¨60 VPS |

### Economia Anual: ~‚Ç¨48 (~R$ 280)

---

## 9. CRONOGRAMA ATUALIZADO

**Total: 26 semanas (6.5 meses)**

| Fase | Semanas | Descri√ß√£o |
|------|---------|-----------|
| 0 | 1 | POC (DeepFace + Prot√≥tipo) üÜï |
| 1 | 2-3 | Setup Inicial |
| 2 | 4 | Setup DeepFace API üÜï |
| 3 | 5-6 | Autentica√ß√£o e Perfis |
| 4 | 7-8 | Registro de Ponto Core |
| 5 | 9 | C√≥digo e QR |
| 6 | 10-11 | Reconhecimento Facial (DeepFace) üîÑ |
| 7 | 12 | Geolocaliza√ß√£o |
| 8 | 13 | Justificativas |
| 9 | 14-15 | C√°lculo de Folha |
| 10 | 16-17 | Relat√≥rios |
| 11 | 18 | Chat Interno |
| 12 | 19 | Advert√™ncias |
| 13 | 20 | LGPD |
| 14 | 21 | Configura√ß√µes |
| 15 | 22-24 | Testes (Estendido +1 semana) üîÑ |
| 16 | 25 | Otimiza√ß√µes |
| 17 | 26 | Documenta√ß√£o e Deploy |

**Mudan√ßas da V1.0:**
- ‚úÖ Adicionada Fase 0 (POC)
- ‚úÖ Adicionada Fase 2 (Setup DeepFace)
- ‚úÖ Fase 15 estendida (+1 semana para testes)
- ‚úÖ Timeline mais realista (+6 semanas)

---

## 10. CUSTOS ATUALIZADOS

### 10.1 Desenvolvimento
- 450-700 horas √ó R$ 80-120/hora
- **Total: R$ 36.000 - 84.000**

### 10.2 Infraestrutura Anual

**VPS DeepFace + App:**
- Contabo VPS S: ‚Ç¨4.99/m√™s = ‚Ç¨59.88/ano ‚âà R$ 360/ano ‚úÖ
- OU DigitalOcean: $12/m√™s = $144/ano ‚âà R$ 720/ano

**Outros:**
- Dom√≠nio: R$ 40/ano
- ICP-Brasil: R$ 200-400/ano
- Registro INPI: R$ 175 (√∫nica vez)

**Total Ano 1: R$ 775-1.735/ano** üéØ

### 10.3 Hardware (Opcional)
- Leitores biom√©tricos (2-3): R$ 800-1.800

### 10.4 Total Projeto

**ANO 1: R$ 37.575 - 86.535**  
**Anos seguintes: R$ 775-1.735/ano**

### 10.5 Economia vs V1.0

| Item | V1.0 | V2.0 | Economia |
|------|------|------|----------|
| VPS/m√™s | ‚Ç¨8.99 | ‚Ç¨4.99 | ‚Ç¨4/m√™s |
| VPS/ano | ‚Ç¨108 | ‚Ç¨60 | **‚Ç¨48/ano** |
| RAM necess√°ria | 8 GB | 4 GB | 50% menos |
| Setup | Complexo | Simples | -40% tempo |

**Economia 5 anos: ‚Ç¨240 ‚âà R$ 1.400** üí∞

---

## 11. CONCLUS√ÉO

### 11.1 Stack Recomendada V2.0

**Backend:** PHP 8.1+ / CodeIgniter 4 / MySQL 8.0+  
**Frontend:** HTML5 / JavaScript / Leaflet.js / Bootstrap 5  
**Biometria Facial:** DeepFace (Python + Flask) - SEM DOCKER ‚úÖ  
**Biometria Digital:** SourceAFIS (opcional)  
**Mapas:** OpenStreetMap + Nominatim  
**Infraestrutura:** VPS 4GB (Ubuntu 22.04)

### 11.2 Diferenciais da V2.0

‚úÖ **100% conformidade** Portaria 671/2021, CLT, LGPD  
‚úÖ **Sem Docker** para facial (mais simples)  
‚úÖ **Mais barato:** 50% economia em VPS  
‚úÖ **Mais preciso:** 99.65% vs 99.56%  
‚úÖ **Anti-spoofing:** Detecta fotos falsas  
‚úÖ **8 modelos:** Flexibilidade  
‚úÖ **Cache inteligente:** 5min para reconhecimentos  
‚úÖ **POC obrigat√≥ria:** Validar antes de desenvolver  
‚úÖ **Timeline realista:** 26 semanas  

### 11.3 Pr√≥ximos Passos

1. ‚úÖ Executar POC (Fase 0)
2. ‚úÖ Provisionar VPS (Contabo ‚Ç¨4.99/m√™s ou similar)
3. ‚úÖ Contratar certificado ICP-Brasil (e-CNPJ)
4. ‚úÖ Setup ambiente desenvolvimento
5. ‚úÖ Iniciar Fase 1 (Setup Inicial)
6. ‚úÖ Setup DeepFace API (Fase 2)
7. ‚úÖ Desenvolvimento sequencial (Fases 3-17)
8. ‚úÖ Testes completos (Fase 15)
9. ‚úÖ Deploy em produ√ß√£o (Fase 17)

---

**ESTE PLANO FORNECE SOLU√á√ÉO COMPLETA, FACT√çVEL E OTIMIZADA - VERS√ÉO 2.0 COM DEEPFACE**

üéØ **Principais melhorias sobre V1.0:**
- Sem depend√™ncia de Docker
- 50% mais barato
- Mais simples de manter
- Mesma (ou melhor) qualidade
- Timeline mais realista
- POC obrigat√≥ria
