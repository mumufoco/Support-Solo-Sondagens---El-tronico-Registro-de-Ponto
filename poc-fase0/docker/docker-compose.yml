version: '3.8'

services:
  # Nginx - Proxy Reverso
  nginx:
    image: nginx:alpine
    container_name: poc-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - ../:/var/www/html
    depends_on:
      - php-fpm
    networks:
      - poc-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost"]
      interval: 10s
      timeout: 5s
      retries: 3

  # PHP-FPM 8.1
  php-fpm:
    image: php:8.1-fpm-alpine
    container_name: poc-php-fpm
    volumes:
      - ../:/var/www/html
    environment:
      - MYSQL_HOST=mysql
      - MYSQL_DATABASE=ponto_eletronico_poc
      - MYSQL_USER=poc_user
      - MYSQL_PASSWORD=poc_password
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - poc-network
    command: >
      sh -c "
      apk add --no-cache $PHPIZE_DEPS libpng-dev libsodium-dev &&
      docker-php-ext-install pdo_mysql gd &&
      pecl install redis sodium &&
      docker-php-ext-enable redis sodium &&
      php-fpm
      "
    healthcheck:
      test: ["CMD-SHELL", "php-fpm -t"]
      interval: 10s
      timeout: 5s
      retries: 3

  # MySQL 8.0
  mysql:
    image: mysql:8.0
    container_name: poc-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: ponto_eletronico_poc
      MYSQL_USER: poc_user
      MYSQL_PASSWORD: poc_password
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - poc-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot_password"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Redis 7
  redis:
    image: redis:7-alpine
    container_name: poc-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - poc-network
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3

  # CompreFace - PostgreSQL
  compreface-postgres:
    image: postgres:11.5
    container_name: poc-compreface-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: compreface
    volumes:
      - compreface-db:/var/lib/postgresql/data
    networks:
      - poc-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # CompreFace - Admin
  compreface-admin:
    image: exadel/compreface-admin:latest
    container_name: poc-compreface-admin
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_URL: jdbc:postgresql://compreface-postgres:5432/compreface
      SPRING_PROFILES_ACTIVE: dev
      ENABLE_EMAIL_SERVER: "false"
    depends_on:
      compreface-postgres:
        condition: service_healthy
    networks:
      - poc-network

  # CompreFace - API
  compreface-api:
    image: exadel/compreface-core:latest
    container_name: poc-compreface-api
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_URL: jdbc:postgresql://compreface-postgres:5432/compreface
      SPRING_PROFILES_ACTIVE: dev
      API_JAVA_OPTS: -Xmx4g
    depends_on:
      compreface-postgres:
        condition: service_healthy
      compreface-admin:
        condition: service_started
    networks:
      - poc-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/system/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # CompreFace - Frontend
  compreface-fe:
    image: exadel/compreface-fe:latest
    container_name: poc-compreface-fe
    ports:
      - "8000:80"
    depends_on:
      - compreface-api
      - compreface-admin
    environment:
      API_URL: http://compreface-api:8080
    networks:
      - poc-network

networks:
  poc-network:
    driver: bridge

volumes:
  mysql-data:
    driver: local
  redis-data:
    driver: local
  compreface-db:
    driver: local
